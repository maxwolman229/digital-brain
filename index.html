<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Knowledge Rule Bank — Danieli</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23F2652F' width='100' height='100' rx='15'/><text fill='white' x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='50' font-weight='900'>KB</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800;900&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Barlow', sans-serif; background: #FFFFFF; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #D8CEC3; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #b0a898; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;


const INITIAL_RULES = [
  { id: "R-001", title: "Dilute Sims shredded scrap with prime scrap or DRI", type: "rule", status: "Proposed", confidence: "Medium", category: "Material", processArea: "EAF", scope: "Supplier = Sims Metal Management; Process = EAF", rationale: "Improves liquid steel quality and reduces downstream risk", evidence: [{ type: "human_note", text: "Original operator observation", date: "2025-02-10" }], linkedAssertions: ["A-001"], tags: ["scrap", "sims", "eaf", "dilution"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:00:00Z", versions: [{ version: 1, date: "2025-02-10T09:00:00Z", author: "Max Wolman", change: "Initial capture from operator note", snapshot: "When charging shredded scrap from Sims Metal Management, dilute the charge with prime scrap or DRI when available." }] },
  { id: "R-002", title: "Plan longer EAF heats for undiluted Sims scrap", type: "rule", status: "Proposed", confidence: "Medium", category: "Process", processArea: "EAF", scope: "EAF heats dominated by Sims shredded scrap", rationale: "Additional refining time required to reach acceptable quality", evidence: [{ type: "human_note", text: "Original operator observation", date: "2025-02-10" }], linkedAssertions: ["A-001", "A-002"], tags: ["scrap", "sims", "eaf", "heat-time"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:15:00Z", versions: [{ version: 1, date: "2025-02-10T09:15:00Z", author: "Max Wolman", change: "Initial capture", snapshot: "If Sims shredded scrap is used without sufficient dilution, plan for longer EAF heat times." }] },
  { id: "R-003", title: "Reduce casting speed for undiluted low-quality scrap", type: "rule", status: "Proposed", confidence: "Medium", category: "Process", processArea: "Casting", scope: "Casting following heats with undiluted shredded scrap", rationale: "Slower casting reduces cracking risk under marginal conditions", evidence: [{ type: "human_note", text: "Original operator observation", date: "2025-02-10" }], linkedAssertions: ["A-002", "A-003"], tags: ["casting", "speed", "defects", "cracking"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:30:00Z", versions: [{ version: 1, date: "2025-02-10T09:30:00Z", author: "Max Wolman", change: "Initial capture", snapshot: "If lower quality scrap cannot be diluted, anticipate higher casting defect risk and reduce casting speed." }] },
  { id: "R-004", title: "Monitor slag foaming when using high-residual scrap", type: "rule", status: "Active", confidence: "High", category: "Process", processArea: "EAF", scope: "EAF heats with high Cu/Sn residual scrap", rationale: "High residuals affect slag behavior and energy efficiency", evidence: [{ type: "human_note", text: "Metallurgist observation across 50+ heats", date: "2025-01-15" }], linkedAssertions: ["A-001"], tags: ["slag", "residuals", "eaf", "foaming"], createdBy: "J. Martinez", createdAt: "2025-01-15T14:00:00Z", versions: [{ version: 1, date: "2025-01-15T14:00:00Z", author: "J. Martinez", change: "Initial capture from metallurgist review", snapshot: "Monitor slag foaming behavior closely when using high-residual scrap charges." }] },
  { id: "R-005", title: "Adjust mold oscillation for crack-sensitive grades", type: "rule", status: "Active", confidence: "High", category: "Equipment", processArea: "Casting", scope: "Continuous casting of peritectic and HSLA grades", rationale: "Oscillation tuning reduces surface crack formation", evidence: [{ type: "human_note", text: "Quality team review of defect data 2024 Q3-Q4", date: "2024-12-20" }], linkedAssertions: ["A-003"], tags: ["casting", "mold", "oscillation", "cracks"], createdBy: "L. Chen", createdAt: "2024-12-20T10:00:00Z", versions: [{ version: 1, date: "2024-12-20T10:00:00Z", author: "L. Chen", change: "Initial capture from quality review", snapshot: "Adjust mold oscillation parameters when casting crack-sensitive grades." }] },
  { id: "R-006", title: "Verify ladle refractory life before high-alloy heats", type: "rule", status: "Proposed", confidence: "Medium", category: "Equipment", processArea: "Ladle Furnace", scope: "Ladle Furnace processing for high-alloy grades", rationale: "Worn refractories increase steel contamination risk", evidence: [{ type: "human_note", text: "Shift supervisor incident report", date: "2025-02-01" }], linkedAssertions: ["A-002"], tags: ["ladle", "refractory", "alloy", "contamination"], createdBy: "D. Okonkwo", createdAt: "2025-02-01T08:30:00Z", versions: [{ version: 1, date: "2025-02-01T08:30:00Z", author: "D. Okonkwo", change: "Initial capture", snapshot: "Check ladle refractory campaign life before routing high-alloy heats." }] },
];

const INITIAL_ASSERTIONS = [
  { id: "A-001", title: "Lower quality shredded scrap requires longer EAF heat times", type: "assertion", category: "Process / Material", scope: "EAF heats with Sims scrap", confidence: "Medium", processArea: "EAF", evidence: [{ type: "human_note", text: "Original operator note", date: "2025-02-10" }], linkedRules: ["R-001", "R-002", "R-004"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:00:00Z", versions: [{ version: 1, date: "2025-02-10T09:00:00Z", author: "Max Wolman", change: "Initial", snapshot: "Lower quality shredded scrap requires longer EAF heat times" }] },
  { id: "A-002", title: "Insufficient dilution increases cracking and casting defect risk", type: "assertion", category: "Material / Process", scope: "Casting following heats dominated by Sims shredded scrap", confidence: "Medium", processArea: "Casting", evidence: [{ type: "human_note", text: "Original operator note", date: "2025-02-10" }], linkedRules: ["R-002", "R-003", "R-006"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:10:00Z", versions: [{ version: 1, date: "2025-02-10T09:10:00Z", author: "Max Wolman", change: "Initial", snapshot: "Insufficient dilution increases cracking and casting defect risk" }] },
  { id: "A-003", title: "Slower casting speeds reduce defect risk under marginal conditions", type: "assertion", category: "Process", scope: "Casting under marginal chemistry or cleanliness conditions", confidence: "Medium", processArea: "Casting", evidence: [{ type: "human_note", text: "Original operator note", date: "2025-02-10" }], linkedRules: ["R-003", "R-005"], createdBy: "Max Wolman", createdAt: "2025-02-10T09:20:00Z", versions: [{ version: 1, date: "2025-02-10T09:20:00Z", author: "Max Wolman", change: "Initial", snapshot: "Slower casting speeds reduce defect risk under marginal conditions" }] },
];

// ─── DOMAIN CONFIG — Steel-first, but swap this object to adapt to any industry ───
const DOMAIN = {
  name: "Steel",
  categories: ["Material", "Process", "Equipment", "People", "Measurement", "Environment", "Process / Material", "Material / Process"],
  statuses: ["Proposed", "Active", "Superseded", "Retired"],
  confidences: ["Low", "Medium", "High", "Verified"],
  processAreas: ["EAF", "Casting", "Rolling", "Ladle Furnace", "Scrap Yard", "Quality Lab", "Other"],
  processAreaColors: { EAF: "#F2652F", Casting: "#062044", Rolling: "#4FA89A", "Ladle Furnace": "#F2652F", "Scrap Yard": "#8a8278", "Quality Lab": "#4FA89A", Other: "#999" },
  // Used in LLM prompt so it understands the domain
  contextPrompt: `You are an expert steelmaking knowledge engineer. You understand EAF steelmaking, continuous casting, ladle metallurgy, scrap management, and downstream rolling/finishing. The Ishikawa categories are: Material, Process, Equipment, People, Measurement, Environment. Process areas include: EAF, Casting, Rolling, Ladle Furnace, Scrap Yard, Quality Lab.`,
};
const ISHIKAWA_CATS = ["Material", "Process", "Equipment", "People", "Measurement", "Environment"];
const IMPACTS = ["Minor", "Moderate", "Significant", "Major"];
const EVENT_STATUSES = ["Open", "Investigating", "Closed"];
const EVENT_OUTCOMES = ["Positive", "Negative"];

const INITIAL_EVENTS = [
  {
    id: "E-001", title: "Surface cracking on HSLA billet — Heat #4782", type: "event",
    outcome: "Negative", impact: "Significant", status: "Closed", processArea: "Casting", date: "2025-02-08T06:30:00Z",
    description: "Multiple transverse surface cracks detected on HSLA billet during quality inspection post-casting. Heat #4782 used 70% Sims shredded scrap with no prime dilution. Casting speed was standard.",
    ishikawa: {
      Material: ["Sims shredded scrap — high tramp element content", "No prime scrap dilution available"],
      Process: ["Standard casting speed not reduced for marginal chemistry", "EAF heat time not extended"],
      Equipment: ["Mold oscillation set for standard grades, not adjusted for crack sensitivity"],
      People: ["Night shift crew unfamiliar with HSLA casting adjustments"],
      Measurement: ["Spectrometer reading delayed — chemistry confirmed late"],
      Environment: ["Cold ambient temperature — mold cooling rate higher than normal"],
    },
    resolution: "Billets downgraded. Implemented mandatory casting speed reduction when Sims scrap exceeds 50% without dilution.",
    linkedRules: ["R-003", "R-005"], linkedAssertions: ["A-002", "A-003"],
    generatedRules: [], generatedAssertions: [],
    reportedBy: "L. Chen", tags: ["cracking", "hsla", "sims", "casting", "defect"], createdAt: "2025-02-08T06:30:00Z",
  },
  {
    id: "E-002", title: "Excessive slag carry-over into ladle — Heat #4801", type: "event",
    outcome: "Negative", impact: "Moderate", status: "Open", processArea: "EAF", date: "2025-02-12T14:15:00Z",
    description: "Significant slag carry-over observed during EAF tap into ladle. Ladle furnace treatment extended by 12 minutes. Heat used high-residual shredded scrap from mixed suppliers.",
    ishikawa: {
      Material: ["High-residual mixed scrap — poor slag chemistry control"],
      Process: ["Slag foaming unstable during final refining", "Tap procedure rushed due to schedule pressure"],
      Equipment: ["EAF slag door sensor intermittent — delayed detection"],
      People: ["Operator noted slag behavior but did not delay tap"],
      Measurement: [], Environment: [],
    },
    resolution: "", linkedRules: ["R-004"], linkedAssertions: ["A-001"],
    generatedRules: [], generatedAssertions: [],
    reportedBy: "J. Martinez", tags: ["slag", "carry-over", "eaf", "ladle", "residuals"], createdAt: "2025-02-12T14:15:00Z",
  },
  {
    id: "E-003", title: "Zero-defect HSLA campaign — Heats #4810–4818", type: "event",
    outcome: "Positive", impact: "Significant", status: "Closed", processArea: "Casting", date: "2025-02-11T08:00:00Z",
    description: "Nine consecutive HSLA heats cast with zero surface defects. Crew applied reduced casting speed, adjusted mold oscillation for peritectic grades, and ensured all heats had minimum 30% prime scrap dilution. Chemistry confirmed within spec before every tap.",
    ishikawa: {
      Material: ["Prime scrap dilution maintained above 30% on all heats", "Consistent scrap sourcing — avoided Sims shredded for this campaign"],
      Process: ["Casting speed reduced 15% per HSLA protocol", "EAF heat times extended to ensure clean tap chemistry"],
      Equipment: ["Mold oscillation pre-set to crack-sensitive parameters before campaign start"],
      People: ["Day shift A-crew — experienced with HSLA grades, pre-shift briefing held"],
      Measurement: ["Spectrometer readings confirmed before every tap — no delayed chemistry"],
      Environment: ["Moderate ambient temperature — stable mold cooling conditions"],
    },
    resolution: "Campaign documented as best-practice reference. Crew commended. Parameters logged for replication.",
    linkedRules: ["R-003", "R-005"], linkedAssertions: ["A-003"],
    generatedRules: [], generatedAssertions: [],
    reportedBy: "L. Chen", tags: ["hsla", "zero-defect", "casting", "best-practice", "campaign"], createdAt: "2025-02-11T08:00:00Z",
  },
];

const CATEGORIES = DOMAIN.categories;
const STATUSES = DOMAIN.statuses;
const CONFIDENCES = DOMAIN.confidences;
const PROCESS_AREAS = DOMAIN.processAreas;

const formatDate = (iso) => iso ? new Date(iso).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }) : "—";
const confidenceColor = (c) => ({ Low: { bg: "#fde8e5", text: "#c0392b" }, Medium: { bg: "#fef3e2", text: "#e67e22" }, High: { bg: "#e6f5f1", text: "#4FA89A" }, Verified: { bg: "#e8edf4", text: "#062044" } }[c] || { bg: "#f0eeec", text: "#888" });
const statusColor = (s) => ({ Proposed: { bg: "#fef3e2", text: "#F2652F" }, Active: { bg: "#e6f5f1", text: "#4FA89A" }, Superseded: { bg: "#f0eeec", text: "#999" }, Retired: { bg: "#f0eeec", text: "#bbb" } }[s] || { bg: "#f0eeec", text: "#999" });
const paColor = (p) => (DOMAIN.processAreaColors[p] || "#999");

const impactColor = (s) => ({ Minor: { bg: "#f0eeec", text: "#999" }, Moderate: { bg: "#fef3e2", text: "#F2652F" }, Significant: { bg: "#fde8e5", text: "#c0392b" }, Major: { bg: "#f9d6d0", text: "#a01010" } }[s] || { bg: "#f0eeec", text: "#999" });
const eventStatusColor = (s) => ({ Open: { bg: "#fef3e2", text: "#F2652F" }, Investigating: { bg: "#f0eeec", text: "#888" }, Closed: { bg: "#e6f5f1", text: "#4FA89A" } }[s] || { bg: "#f0eeec", text: "#999" });
const outcomeColor = (o) => ({ Positive: { bg: "#e6f5f1", text: "#4FA89A" }, Negative: { bg: "#fde8e5", text: "#c0392b" } }[o] || { bg: "#f0eeec", text: "#999" });

const FNT = "'IBM Plex Sans', 'Helvetica Neue', Arial, sans-serif";
const FNTM = "'IBM Plex Sans', 'Helvetica Neue', Arial, sans-serif";
const Badge = ({ label, colorFn }) => { const c = colorFn(label); return <span style={{ display: "inline-block", padding: "2px 10px", borderRadius: 2, fontSize: 10, fontWeight: 700, letterSpacing: 0.6, background: c.bg, color: c.text, textTransform: "uppercase", fontFamily: FNTM }}>{label}</span>; };
const Tag = ({ label }) => <span style={{ display: "inline-block", padding: "2px 8px", borderRadius: 2, fontSize: 10, fontWeight: 600, background: "#062044", color: "#FFFFFF", marginRight: 4, marginBottom: 3, fontFamily: FNTM, letterSpacing: 0.3 }}>{label}</span>;

const PillFilter = ({ options, selected, onToggle, colorFn, label }) => (
  <div style={{ marginBottom: 12 }}>
    <div style={{ fontSize: 10, color: "#8a8278", textTransform: "uppercase", letterSpacing: 1.2, marginBottom: 6, fontFamily: FNTM }}>{label}</div>
    <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
      {options.map(o => { const a = selected.includes(o); const c = colorFn ? colorFn(o) : { bg: "#f0eeec", text: "#1F1F1F" }; return <button key={o} onClick={() => onToggle(o)} style={{ padding: "3px 10px", borderRadius: 3, fontSize: 11, fontWeight: a ? 700 : 400, background: a ? c.bg : "transparent", color: a ? c.text : "#8a8278", border: a ? `1px solid ${c.text}44` : "1px solid #D8CEC3", cursor: "pointer", fontFamily: FNTM }}>{o}</button>; })}
    </div>
  </div>
);

const Modal = ({ open, onClose, title, children, width = 640 }) => {
  if (!open) return null;
  return <div onClick={onClose} style={{ position: "fixed", inset: 0, background: "rgba(6,32,68,0.5)", zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center", backdropFilter: "blur(4px)" }}>
    <div onClick={e => e.stopPropagation()} style={{ background: "#FFFFFF", border: "1px solid #D8CEC3", borderRadius: 4, width: "90%", maxWidth: width, maxHeight: "85vh", overflow: "auto", padding: 28, boxShadow: "0 20px 60px rgba(6,32,68,0.2)" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h2 style={{ margin: 0, fontSize: 18, color: "#062044", fontFamily: FNT, fontWeight: 800 }}>{title}</h2>
        <button onClick={onClose} style={{ background: "none", border: "none", color: "#8a8278", fontSize: 22, cursor: "pointer" }}>✕</button>
      </div>
      {children}
    </div>
  </div>;
};

const Field = ({ label, children, hint }) => <div style={{ marginBottom: 16 }}><label style={{ display: "block", fontSize: 11, color: "#8a8278", marginBottom: 5, textTransform: "uppercase", letterSpacing: 1, fontFamily: FNTM }}>{label}</label>{children}{hint && <div style={{ fontSize: 10, color: "#b0a898", marginTop: 3, fontStyle: "italic" }}>{hint}</div>}</div>;
const iS = { width: "100%", padding: "8px 12px", background: "#f8f6f4", border: "1px solid #D8CEC3", borderRadius: 3, color: "#1F1F1F", fontSize: 13, fontFamily: FNTM, outline: "none", boxSizing: "border-box" };

// ─── TYPEAHEAD INPUT ───
function TypeaheadInput({ value, onChange, options, placeholder }) {
  const [focused, setFocused] = useState(false);
  const ref = useRef(null);
  const filtered = options.filter(a => a.toLowerCase().includes((value||"").toLowerCase()));
  const show = focused && (value||"").length === 0 ? true : focused && filtered.length > 0 && !(filtered.length === 1 && filtered[0].toLowerCase() === (value||"").toLowerCase());
  useEffect(() => {
    const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setFocused(false); };
    document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h);
  }, []);
  return <div ref={ref} style={{ position: "relative" }}>
    <input value={value||""} onChange={e => onChange(e.target.value)} onFocus={() => setFocused(true)} placeholder={placeholder||"Type or select..."} style={iS} />
    {show && <div style={{ position: "absolute", top: "100%", left: 0, right: 0, background: "#fff", border: "1px solid #D8CEC3", borderRadius: 3, boxShadow: "0 4px 12px rgba(6,32,68,0.1)", zIndex: 10, maxHeight: 150, overflow: "auto", marginTop: 2 }}>
      {((value||"").length === 0 ? options : filtered).map(a => (
        <div key={a} onClick={() => { onChange(a); setFocused(false); }} style={{ padding: "6px 12px", fontSize: 12, cursor: "pointer", fontFamily: FNTM, color: "#1F1F1F" }}
          onMouseEnter={e => e.currentTarget.style.background = "#f0eeec"} onMouseLeave={e => e.currentTarget.style.background = "#fff"}>{a}</div>
      ))}
    </div>}
  </div>;
}

// ─── GRAPH VIEW ───
function GraphView({ rules, assertions, gpf, gcf, onSelect, focusNodeId }) {
  const canvasRef = useRef(null);
  const nodesRef = useRef([]);
  const edgesRef = useRef([]);
  const animRef = useRef(null);
  const dragRef = useRef(null);
  const hovRef = useRef(null);
  const focusRef = useRef(focusNodeId);
  const [tip, setTip] = useState(null);
  const szRef = useRef({ w: 800, h: 600 });

  useEffect(() => { focusRef.current = focusNodeId; }, [focusNodeId]);

  useEffect(() => {
    const all = [...rules, ...assertions];
    const fit = all.filter(i => {
      const mp = gpf.length === 0 || gpf.includes(i.processArea) || gpf.some(p => (i.scope || "").includes(p));
      const mc = gcf.length === 0 || gcf.some(c => (i.category || "").includes(c));
      return mp && mc;
    });
    const ids = new Set(fit.map(i => i.id));
    const groups = {};
    fit.forEach(i => { const pa = i.processArea || "Other"; if (!groups[pa]) groups[pa] = []; groups[pa].push(i); });
    const cx = szRef.current.w / 2, cy = szRef.current.h / 2;
    const keys = Object.keys(groups);
    const nodes = [];
    keys.forEach((pa, gi) => {
      const ang = (gi / Math.max(keys.length, 1)) * Math.PI * 2 - Math.PI / 2;
      const cr = Math.min(szRef.current.w, szRef.current.h) * 0.25;
      const gx = cx + Math.cos(ang) * cr, gy = cy + Math.sin(ang) * cr;
      groups[pa].forEach((item, i) => {
        const sa = (i / Math.max(groups[pa].length, 1)) * Math.PI * 2;
        const sr = 25 + groups[pa].length * 14;
        nodes.push({ id: item.id, label: item.id, title: item.title, type: item.type, processArea: item.processArea || "Other", category: item.category, confidence: item.confidence, status: item.status, x: gx + Math.cos(sa) * sr + (Math.random() - 0.5) * 15, y: gy + Math.sin(sa) * sr + (Math.random() - 0.5) * 15, vx: 0, vy: 0, r: item.type === "rule" ? 24 : 17 });
      });
    });
    const edges = [];
    fit.forEach(item => {
      (item.type === "rule" ? (item.linkedAssertions || []) : (item.linkedRules || [])).forEach(tid => {
        if (ids.has(tid) && !edges.find(e => (e.s === item.id && e.t === tid) || (e.s === tid && e.t === item.id)))
          edges.push({ s: item.id, t: tid });
      });
    });
    nodesRef.current = nodes;
    edgesRef.current = edges;
  }, [rules, assertions, gpf, gcf]);

  useEffect(() => {
    const c = canvasRef.current; if (!c) return;
    const p = c.parentElement;
    const resize = () => { const r = p.getBoundingClientRect(); szRef.current = { w: r.width, h: r.height }; c.width = r.width * 2; c.height = r.height * 2; c.style.width = r.width + "px"; c.style.height = r.height + "px"; };
    resize();
    const ro = new ResizeObserver(resize); ro.observe(p);
    return () => ro.disconnect();
  }, []);

  useEffect(() => {
    const c = canvasRef.current; if (!c) return;
    const ctx = c.getContext("2d");
    let on = true;
    const tick = () => {
      if (!on) return;
      const ns = nodesRef.current, es = edgesRef.current;
      const W = szRef.current.w, H = szRef.current.h;
      // repulsion
      for (let i = 0; i < ns.length; i++) for (let j = i + 1; j < ns.length; j++) {
        const dx = ns[j].x - ns[i].x, dy = ns[j].y - ns[i].y, d = Math.sqrt(dx*dx+dy*dy)||1;
        const f = 3200/(d*d), fx = dx/d*f, fy = dy/d*f;
        ns[i].vx -= fx; ns[i].vy -= fy; ns[j].vx += fx; ns[j].vy += fy;
      }
      const nm = {}; ns.forEach(n => nm[n.id] = n);
      // attraction
      es.forEach(e => {
        const a = nm[e.s], b = nm[e.t]; if (!a||!b) return;
        const dx = b.x-a.x, dy = b.y-a.y, d = Math.sqrt(dx*dx+dy*dy)||1, f = (d-110)*0.009;
        a.vx += dx/d*f; a.vy += dy/d*f; b.vx -= dx/d*f; b.vy -= dy/d*f;
      });
      // gravity + integrate
      ns.forEach(n => {
        n.vx += (W/2-n.x)*0.012; n.vy += (H/2-n.y)*0.012;
        if (dragRef.current && dragRef.current.id === n.id) return;
        n.vx *= 0.86; n.vy *= 0.86; n.x += n.vx; n.y += n.vy;
        n.x = Math.max(n.r+10, Math.min(W-n.r-10, n.x));
        n.y = Math.max(n.r+10, Math.min(H-n.r-10, n.y));
      });
      // render
      ctx.save(); ctx.scale(2,2);
      ctx.clearRect(0,0,W,H); ctx.fillStyle="#FFFFFF"; ctx.fillRect(0,0,W,H);
      // grid
      ctx.fillStyle="#e8e4e0";
      for (let x=0;x<W;x+=30) for (let y=0;y<H;y+=30) ctx.fillRect(x,y,1,1);
      // cluster labels
      const cl = {};
      ns.forEach(n => { if(!cl[n.processArea]) cl[n.processArea]={x:0,y:0,c:0}; cl[n.processArea].x+=n.x; cl[n.processArea].y+=n.y; cl[n.processArea].c++; });
      Object.entries(cl).forEach(([pa,v]) => {
        const cx=v.x/v.c, cy=v.y/v.c;
        ctx.font="bold 10px IBM Plex Sans, sans-serif"; ctx.textAlign="center";
        ctx.fillStyle=paColor(pa)+"50"; ctx.fillText(pa.toUpperCase(),cx,cy-55);
        ctx.beginPath(); ctx.arc(cx,cy,65+v.c*16,0,Math.PI*2);
        ctx.strokeStyle=paColor(pa)+"10"; ctx.lineWidth=1.5; ctx.setLineDash([4,6]); ctx.stroke(); ctx.setLineDash([]);
      });
      const hov = hovRef.current;
      const focId = focusRef.current;
      const focConnected = focId ? new Set(es.filter(e=>e.s===focId||e.t===focId).flatMap(e=>[e.s,e.t])) : null;
      // edges
      es.forEach(e => {
        const a=nm[e.s], b=nm[e.t]; if(!a||!b) return;
        const hl = hov && (hov.id===e.s||hov.id===e.t);
        const fl = focId && (e.s===focId||e.t===focId);
        const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
        const dx=b.x-a.x, dy=b.y-a.y, nx=-dy*0.08, ny=dx*0.08;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.quadraticCurveTo(mx+nx,my+ny,b.x,b.y);
        ctx.strokeStyle=(hl||fl)?"#4FA89A88":focId&&!fl?"#D8CEC318":"#D8CEC380"; ctx.lineWidth=(hl||fl)?2.5:1; ctx.stroke();
        const at=0.5,dt=0.01;
        const px=(1-at)*(1-at)*a.x+2*(1-at)*at*(mx+nx)+at*at*b.x;
        const py=(1-at)*(1-at)*a.y+2*(1-at)*at*(my+ny)+at*at*b.y;
        const px2=(1-at-dt)*(1-at-dt)*a.x+2*(1-at-dt)*(at+dt)*(mx+nx)+(at+dt)*(at+dt)*b.x;
        const py2=(1-at-dt)*(1-at-dt)*a.y+2*(1-at-dt)*(at+dt)*(my+ny)+(at+dt)*(at+dt)*b.y;
        const ang=Math.atan2(py2-py,px2-px);
        ctx.save(); ctx.translate(px,py); ctx.rotate(ang);
        ctx.beginPath(); ctx.moveTo(6,0); ctx.lineTo(-4,-4); ctx.lineTo(-4,4); ctx.closePath();
        ctx.fillStyle=(hl||fl)?"#4FA89A70":"#D8CEC360"; ctx.fill(); ctx.restore();
      });
      // nodes
      ns.forEach(n => {
        const isH=hov&&hov.id===n.id;
        const isC=hov&&es.some(e=>(e.s===hov.id&&e.t===n.id)||(e.t===hov.id&&e.s===n.id));
        const isFoc = focId && n.id===focId;
        const isFocC = focConnected && focConnected.has(n.id);
        const dim=(hov&&!isH&&!isC)||(focId&&!isFoc&&!isFocC);
        const col=paColor(n.processArea);
        if(isH||isFoc){ctx.beginPath();ctx.arc(n.x,n.y,n.r+(isFoc?14:10),0,Math.PI*2);const g=ctx.createRadialGradient(n.x,n.y,n.r,n.x,n.y,n.r+(isFoc?14:10));g.addColorStop(0,(isFoc?"#F2652F":col)+"35");g.addColorStop(1,"transparent");ctx.fillStyle=g;ctx.fill();}
        ctx.beginPath();
        if(n.type==="rule"){const s=n.r,x=n.x-s,y=n.y-s,w=s*2,h=s*2,cr=7;ctx.moveTo(x+cr,y);ctx.lineTo(x+w-cr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+cr);ctx.lineTo(x+w,y+h-cr);ctx.quadraticCurveTo(x+w,y+h,x+w-cr,y+h);ctx.lineTo(x+cr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-cr);ctx.lineTo(x,y+cr);ctx.quadraticCurveTo(x,y,x+cr,y);}
        else ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
        ctx.fillStyle=dim?"#FFFFFF0d":"#FFFFFFf0"; ctx.fill();
        ctx.strokeStyle=dim?col+"28":isH?col:col+"80"; ctx.lineWidth=isH?2.5:1.5; ctx.stroke();
        ctx.font=`bold ${n.type==="rule"?10:9}px IBM Plex Sans, sans-serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillStyle=dim?col+"28":col; ctx.fillText(n.label,n.x,n.y);
        const cc=confidenceColor(n.confidence);
        ctx.beginPath(); ctx.arc(n.x+n.r-5,n.y-n.r+5,4,0,Math.PI*2);
        ctx.fillStyle=dim?cc.text+"18":cc.text; ctx.fill();
      });
      ctx.restore();
      animRef.current=requestAnimationFrame(tick);
    };
    animRef.current=requestAnimationFrame(tick);
    return ()=>{on=false;cancelAnimationFrame(animRef.current);};
  },[rules,assertions,gpf,gcf]);

  const getN=e=>{const r=canvasRef.current.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;return nodesRef.current.find(n=>Math.sqrt((n.x-mx)**2+(n.y-my)**2)<n.r+4);};

  return <div style={{position:"relative",width:"100%",height:"100%"}}>
    <canvas ref={canvasRef}
      onMouseDown={e=>{const n=getN(e);if(n){dragRef.current=n;n.vx=0;n.vy=0;}}}
      onMouseMove={e=>{const r=canvasRef.current.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;if(dragRef.current){dragRef.current.x=mx;dragRef.current.y=my;return;}const n=getN(e);hovRef.current=n||null;canvasRef.current.style.cursor=n?"grab":"default";setTip(n?{x:mx,y:my,node:n}:null);}}
      onMouseUp={()=>{dragRef.current=null;}}
      onMouseLeave={()=>{dragRef.current=null;hovRef.current=null;setTip(null);}}
      onDoubleClick={e=>{const n=getN(e);if(n){const it=[...rules,...assertions].find(i=>i.id===n.id);if(it)onSelect(it);}}}
      style={{display:"block",width:"100%",height:"100%"}}/>
    <div style={{position:"absolute",bottom:16,left:16,background:"#FFFFFFee",border:"1px solid #D8CEC3",borderRadius:3,padding:"10px 14px",fontSize:10,fontFamily:FNTM,color:"#8a8278"}}>
      <div style={{marginBottom:6,fontWeight:700,color:"#062044",letterSpacing:0.8}}>LEGEND</div>
      <div style={{display:"flex",gap:14,alignItems:"center",marginBottom:5}}>
        <span style={{display:"flex",alignItems:"center",gap:4}}><span style={{display:"inline-block",width:14,height:14,borderRadius:2,border:"1.5px solid #F2652F"}}/> Rule</span>
        <span style={{display:"flex",alignItems:"center",gap:4}}><span style={{display:"inline-block",width:12,height:12,borderRadius:"50%",border:"1.5px solid #4FA89A"}}/> Assertion</span>
      </div>
      <div style={{display:"flex",gap:8,flexWrap:"wrap",marginTop:4}}>
        {["EAF","Casting","Ladle Furnace"].map(pa=><span key={pa} style={{display:"flex",alignItems:"center",gap:3}}><span style={{display:"inline-block",width:8,height:8,borderRadius:2,background:paColor(pa)}}/> {pa}</span>)}
      </div>
      <div style={{display:"flex",gap:8,flexWrap:"wrap",marginTop:5,borderTop:"1px solid #D8CEC3",paddingTop:5}}>
        {["Low","Medium","High","Verified"].map(c=><span key={c} style={{display:"flex",alignItems:"center",gap:3}}><span style={{display:"inline-block",width:7,height:7,borderRadius:"50%",background:confidenceColor(c).text}}/> {c}</span>)}
      </div>
      <div style={{marginTop:6,color:"#b0a898",fontStyle:"italic"}}>Double-click node to inspect · Drag to reposition</div>
    </div>
    {tip&&<div style={{position:"absolute",left:Math.min(tip.x+14,szRef.current.w-270),top:Math.max(tip.y-12,10),background:"#FFFFFFf0",border:"1px solid #D8CEC3",borderRadius:3,padding:"10px 14px",maxWidth:260,pointerEvents:"none",boxShadow:"0 8px 24px rgba(6,32,68,0.15)"}}>
      <div style={{fontSize:11,fontWeight:700,color:paColor(tip.node.processArea),fontFamily:FNTM,marginBottom:4}}>{tip.node.label} · {tip.node.type.toUpperCase()}</div>
      <div style={{fontSize:11,color:"#1F1F1F",lineHeight:1.4,marginBottom:6}}>{tip.node.title}</div>
      <div style={{display:"flex",gap:4}}><Badge label={tip.node.confidence} colorFn={confidenceColor}/>{tip.node.status&&<Badge label={tip.node.status} colorFn={statusColor}/>}</div>
    </div>}
  </div>;
}

// ─── MAIN APP ───
function KnowledgeRuleBank() {
  const [rules, setRules] = useState(INITIAL_RULES);
  const [assertions, setAssertions] = useState(INITIAL_ASSERTIONS);
  const [events, setEvents] = useState(INITIAL_EVENTS);
  const [search, setSearch] = useState("");
  const [view, setView] = useState("rules");
  const [sel, setSel] = useState(null);
  const [showAdd, setShowAdd] = useState(false);
  const [showEdit, setShowEdit] = useState(false);
  const [showVer, setShowVer] = useState(null);
  const [showNarr, setShowNarr] = useState(false);
  const [showEvent, setShowEvent] = useState(false);
  const [showEventDetail, setShowEventDetail] = useState(null);
  const [fStatus, setFStatus] = useState([]);
  const [fConf, setFConf] = useState([]);
  const [fCat, setFCat] = useState([]);
  const [fProc, setFProc] = useState([]);
  const [gpf, setGpf] = useState([]);
  const [gcf, setGcf] = useState([]);
  const [focusGraph, setFocusGraph] = useState(null);
  const tog = (a, s, v) => s(p => p.includes(v) ? p.filter(x => x !== v) : [...p, v]);

  const filtered = (view === "rules" ? rules : view === "assertions" ? assertions : []).filter(i => {
    const q = search.toLowerCase();
    return (!q || i.title.toLowerCase().includes(q) || i.id.toLowerCase().includes(q) || (i.scope||"").toLowerCase().includes(q) || (i.tags||[]).some(t=>t.includes(q)) || (i.rationale||"").toLowerCase().includes(q))
      && (fStatus.length===0||(i.status&&fStatus.includes(i.status)))
      && (fConf.length===0||fConf.includes(i.confidence))
      && (fCat.length===0||fCat.some(c=>(i.category||"").includes(c)))
      && (fProc.length===0||(i.processArea&&fProc.includes(i.processArea)));
  });

  const ef = { title:"", category:"Process", processArea:"EAF", scope:"", rationale:"", confidence:"Medium", status:"Proposed", tags:"", evidenceText:"", createdBy:"" };
  const [form, setForm] = useState(ef);
  const handleAdd = () => {
    const now = new Date().toISOString();
    const tv = view === "assertions" ? "assertions" : "rules";
    const id = tv === "rules" ? `R-${String(rules.length+1).padStart(3,"0")}` : `A-${String(assertions.length+1).padStart(3,"0")}`;
    const ni = { id, title:form.title, type:tv==="rules"?"rule":"assertion", status:form.status, confidence:form.confidence, category:form.category, processArea:form.processArea, scope:form.scope, rationale:form.rationale||"", evidence:form.evidenceText?[{type:"human_note",text:form.evidenceText,date:now.split("T")[0]}]:[], linkedAssertions:[], linkedRules:[], tags:form.tags.split(",").map(t=>t.trim()).filter(Boolean), createdBy:form.createdBy||"System", createdAt:now, versions:[{version:1,date:now,author:form.createdBy||"System",change:"Initial capture",snapshot:form.title}] };
    if (tv==="rules") setRules(p=>[...p,ni]); else setAssertions(p=>[...p,ni]);
    setForm(ef); setShowAdd(false);
  };

  const [eForm, setEForm] = useState(null);
  const openEdit = i => { setEForm({...i, tags:(i.tags||[]).join(", "), editNote:"", editAuthor:""}); setShowEdit(true); };
  const handleEdit = () => {
    if (!eForm) return;
    const now = new Date().toISOString();
    const u = p => p.map(i => {
      if (i.id !== eForm.id) return i;
      // Compute field-by-field diff
      const newTags = eForm.tags.split(",").map(t=>t.trim()).filter(Boolean);
      const diffs = [];
      if (eForm.title !== i.title) diffs.push({ field: "title", from: i.title, to: eForm.title });
      if (eForm.status !== i.status) diffs.push({ field: "status", from: i.status, to: eForm.status });
      if (eForm.confidence !== i.confidence) diffs.push({ field: "confidence", from: i.confidence, to: eForm.confidence });
      if (eForm.category !== i.category) diffs.push({ field: "category", from: i.category, to: eForm.category });
      if (eForm.processArea !== (i.processArea||"")) diffs.push({ field: "processArea", from: i.processArea||"", to: eForm.processArea });
      if (eForm.scope !== (i.scope||"")) diffs.push({ field: "scope", from: i.scope||"", to: eForm.scope });
      if ((eForm.rationale||"") !== (i.rationale||"")) diffs.push({ field: "rationale", from: i.rationale||"", to: eForm.rationale||"" });
      const oldTags = (i.tags||[]).join(", ");
      const newTagStr = newTags.join(", ");
      if (oldTags !== newTagStr) diffs.push({ field: "tags", from: oldTags, to: newTagStr });

      return {
        ...i,
        title: eForm.title, status: eForm.status, confidence: eForm.confidence,
        category: eForm.category, processArea: eForm.processArea, scope: eForm.scope,
        rationale: eForm.rationale || i.rationale, tags: newTags,
        versions: [...(i.versions||[]), {
          version: (i.versions||[]).length + 1,
          date: now,
          author: eForm.editAuthor || "System",
          change: eForm.editNote || "Updated",
          diffs: diffs,
          fieldsChanged: diffs.map(d => d.field),
          snapshot: eForm.title,
        }],
      };
    });
    if (eForm.type==="rule") setRules(u); else setAssertions(u);
    setShowEdit(false); setEForm(null);
  };

  const [narr, setNarr] = useState("");
  const [parsed, setParsed] = useState(null);
  const [parsing, setParsing] = useState(false);
  const [parseError, setParseError] = useState(null);
  const [recording, setRecording] = useState(false);
  const [fileLoading, setFileLoading] = useState(false);
  const recognitionRef = useRef(null);

  // ─── FILE UPLOAD HANDLER ───
  const handleFileUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setFileLoading(true);
    setParseError(null);
    try {
      const ext = file.name.split(".").pop().toLowerCase();
      if (ext === "txt" || ext === "md" || ext === "csv") {
        const text = await file.text();
        setNarr(prev => prev ? prev + "\n\n" + text : text);
      } else if (ext === "pdf") {
        // Read PDF as base64 for Claude to parse
        const buffer = await file.arrayBuffer();
        const bytes = new Uint8Array(buffer);
        let binary = "";
        bytes.forEach(b => binary += String.fromCharCode(b));
        const b64 = btoa(binary);
        setNarr(prev => prev ? prev + "\n\n[PDF uploaded: " + file.name + " — content will be sent for extraction]" : "[PDF uploaded: " + file.name + " — content will be sent for extraction]");
        // Store base64 for API call
        setNarr("[PDF:" + b64 + ":" + file.name + "]");
      } else if (ext === "docx") {
        // Use mammoth if available, otherwise read as text
        const text = await file.text();
        setNarr(prev => prev ? prev + "\n\n" + text : text);
      } else {
        const text = await file.text();
        setNarr(prev => prev ? prev + "\n\n" + text : text);
      }
    } catch (err) {
      setParseError("Could not read file: " + err.message);
    }
    setFileLoading(false);
    e.target.value = "";
  };

  // ─── VOICE RECORDING ───
  const toggleVoice = () => {
    if (recording) {
      if (recognitionRef.current) recognitionRef.current.stop();
      setRecording(false);
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { setParseError("Voice input not supported in this browser. Try Chrome."); return; }
    const recognition = new SR();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "en-US";
    let finalText = "";
    recognition.onresult = (event) => {
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          finalText += event.results[i][0].transcript + " ";
        } else {
          interim = event.results[i][0].transcript;
        }
      }
      setNarr(prev => {
        const base = prev.replace(/\[listening\.\.\.\].*$/, "").trim();
        const combined = (base ? base + " " : "") + finalText + (interim ? "[listening...] " + interim : "");
        return combined.trim();
      });
    };
    recognition.onerror = (e) => { setParseError("Voice error: " + e.error); setRecording(false); };
    recognition.onend = () => {
      setRecording(false);
      setNarr(prev => prev.replace(/\[listening\.\.\.\].*$/, "").trim());
    };
    recognitionRef.current = recognition;
    recognition.start();
    setRecording(true);
  };

  // ─── AUTO-LINKING ENGINE ───
  // Deterministic: computes overlap score between a new item and all existing items
  const computeLinks = (newItem, existingRules, existingAssertions) => {
    const pool = newItem.type === "rule" ? existingAssertions : existingRules;
    const scored = pool.map(candidate => {
      let score = 0;
      if (newItem.processArea && candidate.processArea === newItem.processArea) score += 3;
      if (newItem.category && candidate.category && (
        newItem.category.includes(candidate.category) || candidate.category.includes(newItem.category)
      )) score += 2;
      const newTags = new Set(newItem.tags || []);
      const candTags = candidate.tags || [];
      const titleWords = (candidate.title || "").toLowerCase().split(/\s+/).filter(w => w.length > 3);
      const newTitleWords = new Set((newItem.title || "").toLowerCase().split(/\s+/).filter(w => w.length > 3));
      titleWords.forEach(w => { if (newTitleWords.has(w)) score += 1; });
      candTags.forEach(t => { if (newTags.has(t)) score += 1.5; });
      const scopeWords = new Set((newItem.scope || "").toLowerCase().split(/[\s;=,]+/).filter(w => w.length > 2));
      const candScopeWords = (candidate.scope || "").toLowerCase().split(/[\s;=,]+/).filter(w => w.length > 2);
      candScopeWords.forEach(w => { if (scopeWords.has(w)) score += 1; });
      return { id: candidate.id, title: candidate.title, score };
    }).filter(s => s.score >= 3).sort((a, b) => b.score - a.score).slice(0, 5);
    return scored;
  };

  // ─── CONTRADICTION DETECTION ENGINE ───
  const OPPOSE = [
    [/\breduce\b/i, /\bmaintain\b|\bstandard\b|\bnormal\b/i],
    [/\bslow\b|\bdecrease\b|\blower\b/i, /\bfast\b|\bincrease\b|\bhigher\b|\bstandard\b/i],
    [/\bavoid\b|\bnever\b|\bdo not\b|\bprohibit\b/i, /\buse\b|\ballow\b|\bpermit\b/i],
    [/\bextend\b|\blonger\b/i, /\bshorten\b|\bshorter\b|\breduce time\b/i],
    [/\brequire\b|\bmandatory\b|\balways\b/i, /\boptional\b|\bskip\b|\bnot required\b/i],
  ];
  const detectContradictions = (allRules) => {
    const contradictions = [];
    for (let i = 0; i < allRules.length; i++) {
      for (let j = i + 1; j < allRules.length; j++) {
        const a = allRules[i], b = allRules[j];
        if (a.status === "Retired" || b.status === "Retired") continue;
        if (a.status === "Superseded" || b.status === "Superseded") continue;
        // Must share process area or category
        const shareArea = a.processArea && b.processArea && a.processArea === b.processArea;
        const shareCat = a.category && b.category && (a.category.includes(b.category) || b.category.includes(a.category));
        const shareTags = (a.tags || []).some(t => (b.tags || []).includes(t));
        if (!shareArea && !shareCat) continue;
        // Check for opposing language
        const tA = (a.title || "").toLowerCase();
        const tB = (b.title || "").toLowerCase();
        for (const [pat1, pat2] of OPPOSE) {
          if ((pat1.test(tA) && pat2.test(tB)) || (pat1.test(tB) && pat2.test(tA))) {
            // Scope overlap check — contradictions only matter if scopes overlap
            const scopeOverlap = !a.scope || !b.scope || a.scope === b.scope ||
              (a.scope || "").split(/[\s;,]+/).some(w => w.length > 2 && (b.scope || "").toLowerCase().includes(w.toLowerCase()));
            if (scopeOverlap) {
              contradictions.push({ ruleA: a, ruleB: b, reason: "Opposing directives in same area", shared: shareArea ? a.processArea : a.category });
              break;
            }
          }
        }
      }
    }
    return contradictions;
  };

  // ─── CONFIDENCE SCORING ENGINE ───
  const EVIDENCE_WEIGHTS = { human_note: 3, event_analysis: 2, llm_extraction: 1, lab_data: 4, validated: 5 };
  const computeConfidenceScore = (item) => {
    const evidence = item.evidence || [];
    let score = 0;
    evidence.forEach(e => { score += (EVIDENCE_WEIGHTS[e.type] || 1); });
    // Corroborating links boost
    const links = item.linkedAssertions || item.linkedRules || [];
    score += links.length * 0.5;
    // Version maturity — more versions = more reviewed
    score += Math.min((item.versions || []).length * 0.5, 2);
    // Event corroboration — check if events reference this rule
    const eventRefs = events.filter(ev =>
      (ev.linkedRules || []).includes(item.id) ||
      (ev.linkedAssertions || []).includes(item.id) ||
      (ev.generatedRules || []).includes(item.id) ||
      (ev.generatedAssertions || []).includes(item.id)
    );
    score += eventRefs.length * 1.5;
    // Contradictions weaken confidence
    const contras = contradictions.filter(c => c.ruleA.id === item.id || c.ruleB.id === item.id);
    score -= contras.length * 2;
    return Math.max(0, score);
  };
  const scoreToLabel = (score) => {
    if (score >= 12) return "Verified";
    if (score >= 7) return "High";
    if (score >= 3) return "Medium";
    return "Low";
  };

  // ─── STALENESS DETECTION ───
  const STALE_DAYS = 90;
  const checkStaleness = (item) => {
    const now = Date.now();
    // Most recent activity: latest version, or creation date
    const versions = item.versions || [];
    const lastActivity = versions.length > 0
      ? Math.max(...versions.map(v => new Date(v.date).getTime()))
      : new Date(item.createdAt).getTime();
    // Check if any recent events reference this item
    const recentEventRef = events.some(ev => {
      const evDate = new Date(ev.date || ev.createdAt).getTime();
      if (now - evDate > STALE_DAYS * 86400000) return false;
      return (ev.linkedRules || []).includes(item.id) ||
        (ev.linkedAssertions || []).includes(item.id) ||
        (ev.generatedRules || []).includes(item.id) ||
        (ev.generatedAssertions || []).includes(item.id);
    });
    if (recentEventRef) return { stale: false };
    const daysSince = Math.floor((now - lastActivity) / 86400000);
    return { stale: daysSince > STALE_DAYS, daysSince };
  };

  // ─── COMPUTE HEALTH METRICS ───
  const contradictions = detectContradictions(rules);
  const healthScores = {};
  [...rules, ...assertions].forEach(item => {
    healthScores[item.id] = computeConfidenceScore(item);
  });
  const staleItems = [...rules, ...assertions].filter(item => {
    if (item.status === "Retired" || item.status === "Superseded") return false;
    return checkStaleness(item).stale;
  });
  const confidenceDrifts = [...rules, ...assertions].filter(item => {
    const computed = scoreToLabel(healthScores[item.id] || 0);
    return computed !== item.confidence && item.status !== "Retired" && item.status !== "Superseded";
  });

  // ─── CLAUDE API NARRATIVE PARSER ───
  const parseNarr = async () => {
    setParsing(true);
    setParseError(null);
    try {
      const systemPrompt = `${DOMAIN.contextPrompt}

You extract structured knowledge from operator narratives. Given free-text input, return ONLY a JSON object (no markdown, no backticks, no preamble) with this exact structure:
{
  "eventType": "short description of the event/observation type",
  "category": "one of: ${CATEGORIES.join(", ")}",
  "processArea": "one of: ${PROCESS_AREAS.join(", ")}",
  "scope": "specific conditions where this applies, e.g. Supplier = X; Process = EAF",
  "tags": ["array", "of", "relevant", "keywords"],
  "assertions": [
    {
      "title": "Clear factual statement derived from the narrative",
      "category": "Ishikawa category",
      "scope": "specific applicability",
      "confidence": "Low or Medium"
    }
  ],
  "rules": [
    {
      "title": "Actionable operational rule in imperative form",
      "category": "Ishikawa category",
      "processArea": "where this applies",
      "scope": "specific conditions",
      "rationale": "why this rule matters",
      "confidence": "Low or Medium"
    }
  ]
}

Extract ALL distinct assertions (observed facts/patterns) and rules (actionable guidance) from the text. For short notes, this may be 2-4 assertions and 1-3 rules. For longer documents, extract every distinct piece of operational knowledge — there is no upper limit. Each assertion and rule should be specific and non-overlapping. Set confidence to "Medium" only if the text references repeated observations or data; otherwise use "Low".`;

      const response = await fetch("/api/claude", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          system: systemPrompt,
          messages: [{ role: "user", content: narr }],
        }),
      });
      const data = await response.json();
      const text = data.content.map(b => b.type === "text" ? b.text : "").join("");
      const clean = text.replace(/```json|```/g, "").trim();
      const result = JSON.parse(clean);

      // Validate and normalize
      const validated = {
        eventType: result.eventType || "Operational observation",
        category: CATEGORIES.includes(result.category) ? result.category : "Process",
        processArea: PROCESS_AREAS.includes(result.processArea) ? result.processArea : "Other",
        scope: result.scope || "",
        tags: Array.isArray(result.tags) ? result.tags.map(t => t.toLowerCase()) : [],
        assertions: (result.assertions || []).map(a => ({
          title: a.title,
          category: CATEGORIES.includes(a.category) ? a.category : result.category || "Process",
          scope: a.scope || result.scope || "",
          confidence: CONFIDENCES.includes(a.confidence) ? a.confidence : "Low",
        })),
        rules: (result.rules || []).map(r => ({
          title: r.title,
          category: CATEGORIES.includes(r.category) ? r.category : result.category || "Process",
          processArea: PROCESS_AREAS.includes(r.processArea) ? r.processArea : result.processArea || "Other",
          scope: r.scope || result.scope || "",
          rationale: r.rationale || "",
          confidence: CONFIDENCES.includes(r.confidence) ? r.confidence : "Low",
        })),
        originalText: narr,
      };
      setParsed(validated);
    } catch (err) {
      console.error("Parse error:", err);
      setParseError("Failed to parse narrative. " + (err.message || "Check console for details."));
    }
    setParsing(false);
  };

  const acceptNarr = () => {
    if (!parsed) return;
    const now = new Date().toISOString();
    const dateStr = now.split("T")[0];

    // Create assertions
    const newAssertions = parsed.assertions.map((a, i) => {
      const id = `A-${String(assertions.length + i + 1).padStart(3, "0")}`;
      const item = {
        id, title: a.title, type: "assertion", category: a.category,
        scope: a.scope, confidence: a.confidence, processArea: parsed.processArea,
        evidence: [{ type: "llm_extraction", text: "Extracted from operator narrative", date: dateStr }, { type: "human_note", text: parsed.originalText, date: dateStr }],
        linkedRules: [], createdBy: "AI Parser (review required)", createdAt: now,
        tags: parsed.tags,
        versions: [{ version: 1, date: now, author: "AI Parser", change: "Auto-extracted from narrative — pending human review", snapshot: a.title }],
      };
      return item;
    });

    // Create rules
    const newRules = parsed.rules.map((r, i) => {
      const id = `R-${String(rules.length + i + 1).padStart(3, "0")}`;
      const item = {
        id, title: r.title, type: "rule", status: "Proposed", confidence: r.confidence,
        category: r.category, processArea: r.processArea, scope: r.scope,
        rationale: r.rationale,
        evidence: [{ type: "llm_extraction", text: "Extracted from operator narrative", date: dateStr }, { type: "human_note", text: parsed.originalText, date: dateStr }],
        linkedAssertions: [], tags: parsed.tags,
        createdBy: "AI Parser (review required)", createdAt: now,
        versions: [{ version: 1, date: now, author: "AI Parser", change: "Auto-generated from narrative — pending human review", snapshot: r.title }],
      };
      return item;
    });

    // Auto-link: connect new rules to existing + new assertions
    const allAssertionsAfter = [...assertions, ...newAssertions];
    const allRulesAfter = [...rules, ...newRules];
    newRules.forEach(nr => {
      const links = computeLinks(nr, allRulesAfter, allAssertionsAfter);
      nr.linkedAssertions = links.map(l => l.id);
      nr.autoLinkedReasons = links.map(l => ({ id: l.id, score: l.score, title: l.title }));
    });
    newAssertions.forEach(na => {
      const links = computeLinks(na, allRulesAfter, allAssertionsAfter);
      na.linkedRules = links.map(l => l.id);
    });

    setAssertions(p => [...p, ...newAssertions]);
    setRules(p => [...p, ...newRules]);
    setNarr(""); setParsed(null); setShowNarr(false);
  };

  // ─── EVENT REPORTING ───
  const eventEmpty = {
    title: "", processArea: "EAF", impact: "Moderate", outcome: "Negative", description: "",
    ishikawa: { Material: [""], Process: [""], Equipment: [""], People: [""], Measurement: [""], Environment: [""] },
    resolution: "", reportedBy: "", tags: "",
  };
  const [evForm, setEvForm] = useState(eventEmpty);

  const updateIshikawa = (cat, idx, val) => {
    setEvForm(f => {
      const arr = [...f.ishikawa[cat]];
      arr[idx] = val;
      return { ...f, ishikawa: { ...f.ishikawa, [cat]: arr } };
    });
  };
  const addIshikawaRow = (cat) => {
    setEvForm(f => ({ ...f, ishikawa: { ...f.ishikawa, [cat]: [...f.ishikawa[cat], ""] } }));
  };
  const removeIshikawaRow = (cat, idx) => {
    setEvForm(f => {
      const arr = f.ishikawa[cat].filter((_, i) => i !== idx);
      return { ...f, ishikawa: { ...f.ishikawa, [cat]: arr.length === 0 ? [""] : arr } };
    });
  };

  const handleAddEvent = () => {
    const now = new Date().toISOString();
    const id = `E-${String(events.length + 1).padStart(3, "0")}`;
    const cleanIshikawa = {};
    ISHIKAWA_CATS.forEach(c => { cleanIshikawa[c] = evForm.ishikawa[c].filter(s => s.trim()); });
    const ni = {
      id, title: evForm.title, type: "event", outcome: evForm.outcome, impact: evForm.impact,
      status: "Open", processArea: evForm.processArea, date: now,
      description: evForm.description, ishikawa: cleanIshikawa,
      resolution: evForm.resolution, linkedRules: [], linkedAssertions: [],
      generatedRules: [], generatedAssertions: [],
      reportedBy: evForm.reportedBy || "System",
      tags: evForm.tags.split(",").map(t => t.trim()).filter(Boolean),
      createdAt: now,
    };
    setEvents(p => [...p, ni]);
    setEvForm(eventEmpty);
    setShowEvent(false);
  };

  // Generate rules + assertions from event via Claude API
  const [generating, setGenerating] = useState(false);
  const [genError, setGenError] = useState(null);
  const generateFromEvent = async (evt) => {
    setGenerating(true);
    setGenError(null);
    try {
      const ishikawaText = ISHIKAWA_CATS.map(c => {
        const items = (evt.ishikawa || {})[c] || [];
        return items.length > 0 ? c + ": " + items.join("; ") : null;
      }).filter(Boolean).join("\n");

      const isPositive = evt.outcome === "Positive";

      const systemPrompt = DOMAIN.contextPrompt + " You extract " + (isPositive ? "best-practice rules and success-driven assertions" : "preventive rules and causal assertions") + " from event analyses. " + (isPositive ? "Rules should capture replicable practices." : "Rules should prevent recurrence.") + " Return only valid JSON with keys assertions and rules. No markdown fences. No preamble.";

      const userContent = "Event: " + evt.title + "\nOutcome: " + evt.outcome + "\nDescription: " + evt.description + "\nProcess Area: " + evt.processArea + "\nImpact: " + evt.impact + "\nResolution: " + (evt.resolution || "Pending") + "\n\nIshikawa Contributors:\n" + ishikawaText + "\n\nReturn ONLY this JSON structure:\n{\"assertions\": [{\"title\": \"factual statement\", \"category\": \"Material or Process or Equipment or People or Measurement or Environment\", \"scope\": \"when this applies\", \"confidence\": \"Low or Medium\"}], \"rules\": [{\"title\": \"imperative action rule\", \"category\": \"one category\", \"processArea\": \"" + evt.processArea + "\", \"scope\": \"conditions\", \"rationale\": \"why\", \"confidence\": \"Low or Medium\"}]}";

      const response = await fetch("/api/claude", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          system: systemPrompt,
          messages: [{ role: "user", content: userContent }],
        }),
      });
      const data = await response.json();
      const text = data.content.map(b => b.type === "text" ? b.text : "").join("");
      const clean = text.replace(/```json|```/g, "").trim();
      const result = JSON.parse(clean);
      const now = new Date().toISOString();
      const dateStr = now.split("T")[0];

      const newAssertions = (result.assertions || []).map((a, i) => ({
        id: "A-" + String(assertions.length + i + 1).padStart(3, "0"), title: a.title, type: "assertion",
        category: a.category || "Process", scope: a.scope || "", confidence: a.confidence || "Low",
        processArea: evt.processArea,
        evidence: [{ type: "event_analysis", text: "Generated from event " + evt.id + ": " + evt.title, date: dateStr }],
        linkedRules: [], createdBy: "Event " + evt.id, createdAt: now,
        tags: evt.tags || [],
        versions: [{ version: 1, date: now, author: "Event Analysis", change: "Auto-generated from event " + evt.id, snapshot: a.title }],
      }));

      const newRules = (result.rules || []).map((r, i) => ({
        id: "R-" + String(rules.length + i + 1).padStart(3, "0"), title: r.title, type: "rule",
        status: "Proposed", confidence: r.confidence || "Low", category: r.category || "Process",
        processArea: r.processArea || evt.processArea, scope: r.scope || "",
        rationale: r.rationale || "",
        evidence: [{ type: "event_analysis", text: "Generated from event " + evt.id + ": " + evt.title, date: dateStr }],
        linkedAssertions: newAssertions.map(a => a.id), tags: evt.tags || [],
        createdBy: "Event " + evt.id, createdAt: now,
        versions: [{ version: 1, date: now, author: "Event Analysis", change: "Auto-generated from event " + evt.id, snapshot: r.title }],
      }));

      // Auto-link
      const allA = [...assertions, ...newAssertions];
      const allR = [...rules, ...newRules];
      newRules.forEach(nr => { const links = computeLinks(nr, allR, allA); nr.linkedAssertions = [...new Set([...nr.linkedAssertions, ...links.map(l => l.id)])]; });
      newAssertions.forEach(na => { const links = computeLinks(na, allR, allA); na.linkedRules = links.map(l => l.id); });

      setAssertions(p => [...p, ...newAssertions]);
      setRules(p => [...p, ...newRules]);

      // Update event with generated IDs
      setEvents(p => p.map(item => item.id !== evt.id ? item : {
        ...item,
        generatedRules: [...(item.generatedRules || []), ...newRules.map(r => r.id)],
        generatedAssertions: [...(item.generatedAssertions || []), ...newAssertions.map(a => a.id)],
      }));

      setShowEventDetail({ ...evt, generatedRules: [...(evt.generatedRules||[]), ...newRules.map(r=>r.id)], generatedAssertions: [...(evt.generatedAssertions||[]), ...newAssertions.map(a=>a.id)] });
    } catch (err) {
      console.error("Generate error:", err);
      setGenError(String(err));
    }
    setGenerating(false);
  };

  const handleExport = () => {
    const d = {exportDate:new Date().toISOString(),version:"1.0",rules,assertions,events};
    const b = new Blob([JSON.stringify(d,null,2)],{type:"application/json"});
    const u = URL.createObjectURL(b);
    const a = document.createElement("a"); a.href=u; a.download=`knowledge-bank-${new Date().toISOString().split("T")[0]}.json`; a.click();
    URL.revokeObjectURL(u);
  };

  const sc = {}; rules.forEach(r=>{sc[r.status]=(sc[r.status]||0)+1;});
  const cc = {}; [...rules,...assertions].forEach(r=>{cc[r.confidence]=(cc[r.confidence]||0)+1;});

  return <div style={{minHeight:"100vh",background:"#FFFFFF",color:"#1F1F1F",fontFamily:FNT}}>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

    {/* Header */}
    <div style={{borderBottom:"1px solid #e8e4e0",padding:"12px 28px",display:"flex",alignItems:"center",justifyContent:"space-between",background:"#D8CEC3"}}>
      <div style={{display:"flex",alignItems:"center",gap:14}}>
        <div style={{display:"flex",flexDirection:"column",alignItems:"flex-start"}}>
          <div style={{fontSize:28,fontWeight:700,color:"#1F1F1F",fontFamily:"'IBM Plex Sans', sans-serif",letterSpacing:2,lineHeight:1}}>NEREOS</div>
          <div style={{fontSize:9,color:"#5a5550",fontFamily:FNTM,letterSpacing:2.5,textTransform:"uppercase",marginTop:3,paddingLeft:1}}>Digital Brain</div>
        </div>
      </div>
      <div style={{display:"flex",gap:8}}>
        <button onClick={()=>setShowEvent(true)} style={{padding:"7px 14px",borderRadius:3,fontSize:12,background:"transparent",border:"1px solid #8a827880",color:"#5a5550",cursor:"pointer",fontFamily:FNTM,fontWeight:700,letterSpacing:0.4}}>+ Report Event</button>
        <button onClick={()=>setShowNarr(true)} style={{padding:"7px 14px",borderRadius:3,fontSize:12,background:"transparent",border:"1px solid #F2652F",color:"#F2652F",cursor:"pointer",fontFamily:FNTM,fontWeight:700,letterSpacing:0.4}}>+ Narrative Input</button>
        <button onClick={()=>setShowAdd(true)} style={{padding:"7px 14px",borderRadius:3,fontSize:12,background:"#062044",border:"none",color:"#FFFFFF",cursor:"pointer",fontFamily:FNTM,fontWeight:800,letterSpacing:0.4}}>+ Add {view==="assertions"?"Assertion":"Rule"}</button>
        <button onClick={handleExport} style={{padding:"7px 14px",borderRadius:3,fontSize:12,background:"transparent",border:"1px solid #8a827840",color:"#8a8278",cursor:"pointer",fontFamily:FNTM,fontWeight:600}}>Export JSON</button>
      </div>
    </div>

    {/* Summary */}
    <div style={{padding:"12px 28px",display:"flex",gap:24,borderBottom:"1px solid #e8e4e0",fontSize:11,fontFamily:FNTM,color:"#b0a898",flexWrap:"wrap",alignItems:"center"}}>
      <span><span style={{color:"#F2652F",fontWeight:700}}>{rules.length}</span> Rules</span>
      <span><span style={{color:"#062044",fontWeight:700}}>{assertions.length}</span> Assertions</span>
      <span><span style={{color:"#1F1F1F",fontWeight:700}}>{events.length}</span> Events</span>
      <span style={{color:"#D8CEC3"}}>│</span>
      {Object.entries(sc).map(([s,c])=><span key={s}><Badge label={s} colorFn={statusColor}/> <span style={{color:"#b0a898"}}>{c}</span></span>)}
      <span style={{color:"#D8CEC3"}}>│</span>
      {Object.entries(cc).map(([c,n])=><span key={c}><Badge label={c} colorFn={confidenceColor}/> <span style={{color:"#b0a898"}}>{n}</span></span>)}
      {(contradictions.length+staleItems.length+confidenceDrifts.length)>0&&<>
        <span style={{color:"#D8CEC3"}}>│</span>
        <span onClick={()=>setView("health")} style={{cursor:"pointer",color:"#F2652F",fontWeight:700}}>{contradictions.length>0&&"⚠ "+contradictions.length+" conflict"+(contradictions.length>1?"s":"")}{contradictions.length>0&&(staleItems.length+confidenceDrifts.length)>0?" · ":""}{staleItems.length>0&&staleItems.length+" stale"}{staleItems.length>0&&confidenceDrifts.length>0?" · ":""}{confidenceDrifts.length>0&&confidenceDrifts.length+" drift"+(confidenceDrifts.length>1?"s":"")}</span>
      </>}
    </div>

    <div style={{display:"flex",minHeight:"calc(100vh - 110px)"}}>
      {/* Sidebar */}
      <div style={{width:220,borderRight:"1px solid #e8e4e0",padding:"20px 16px",flexShrink:0,overflow:"auto"}}>
        {view!=="graph"&&<div style={{position:"relative",marginBottom:20}}><input placeholder="Search rules, tags, scope…" value={search} onChange={e=>setSearch(e.target.value)} style={{...iS,paddingLeft:32,fontSize:11}}/><span style={{position:"absolute",left:10,top:8,color:"#b0a898",fontSize:13}}>⌕</span></div>}

        <div style={{marginBottom:24}}>
          {["rules","assertions","events","health","graph"].map(v=><button key={v} onClick={()=>{setView(v);setSel(null);if(v!=="graph")setFocusGraph(null);}} style={{display:"block",width:"100%",padding:"8px 12px",marginBottom:2,borderRadius:3,fontSize:12,fontWeight:view===v?700:400,background:view===v?"#f0eeec":"transparent",color:view===v?"#062044":"#555",border:"none",cursor:"pointer",textAlign:"left",fontFamily:FNTM}}>
            {v==="rules"?"◆ ":v==="assertions"?"◇ ":v==="events"?"● ":v==="health"?"♥ ":"⬡ "}{v==="graph"?"Relationship Graph":v==="events"?"Events":v==="health"?"Knowledge Health":v.charAt(0).toUpperCase()+v.slice(1)}
            {v==="health"?((contradictions.length+staleItems.length+confidenceDrifts.length)>0?<span style={{float:"right",background:"#F2652F",color:"#fff",fontSize:9,fontWeight:800,padding:"1px 6px",borderRadius:8,fontFamily:FNTM}}>{contradictions.length+staleItems.length+confidenceDrifts.length}</span>:null):
            v!=="graph"&&<span style={{float:"right",color:"#D8CEC3",fontSize:11}}>{v==="rules"?rules.length:v==="assertions"?assertions.length:events.length}</span>}
          </button>)}
        </div>

        {view!=="graph"&&view!=="events"&&<>
          {view==="rules"&&<PillFilter label="Status" options={STATUSES} selected={fStatus} onToggle={v=>tog(fStatus,setFStatus,v)} colorFn={statusColor}/>}
          <PillFilter label="Confidence" options={CONFIDENCES} selected={fConf} onToggle={v=>tog(fConf,setFConf,v)} colorFn={confidenceColor}/>
          <PillFilter label="Category" options={["Material","Process","Equipment","People","Measurement","Environment"]} selected={fCat} onToggle={v=>tog(fCat,setFCat,v)}/>
          <PillFilter label="Process Area" options={PROCESS_AREAS.slice(0,4)} selected={fProc} onToggle={v=>tog(fProc,setFProc,v)}/>
          {(fStatus.length>0||fConf.length>0||fCat.length>0||fProc.length>0)&&<button onClick={()=>{setFStatus([]);setFConf([]);setFCat([]);setFProc([]);}} style={{marginTop:8,background:"none",border:"none",color:"#4FA89A",fontSize:11,cursor:"pointer",fontFamily:FNTM}}>✕ Clear filters</button>}
        </>}

        {view==="events"&&<>
          <PillFilter label="Outcome" options={EVENT_OUTCOMES} selected={fCat} onToggle={v=>tog(fCat,setFCat,v)} colorFn={outcomeColor}/>
          <PillFilter label="Impact" options={IMPACTS} selected={fStatus} onToggle={v=>tog(fStatus,setFStatus,v)} colorFn={impactColor}/>
          <PillFilter label="Status" options={EVENT_STATUSES} selected={fConf} onToggle={v=>tog(fConf,setFConf,v)} colorFn={eventStatusColor}/>
          <PillFilter label="Process Area" options={PROCESS_AREAS.slice(0,4)} selected={fProc} onToggle={v=>tog(fProc,setFProc,v)}/>
          {(fCat.length>0||fStatus.length>0||fConf.length>0||fProc.length>0)&&<button onClick={()=>{setFCat([]);setFStatus([]);setFConf([]);setFProc([]);}} style={{marginTop:8,background:"none",border:"none",color:"#4FA89A",fontSize:11,cursor:"pointer",fontFamily:FNTM}}>✕ Clear filters</button>}
        </>}

        {view==="graph"&&<>
          <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1.2,marginBottom:12,fontFamily:FNTM,fontWeight:700}}>GRAPH FILTERS</div>
          <PillFilter label="Process Area" options={["EAF","Casting","Rolling","Ladle Furnace"]} selected={gpf} onToggle={v=>tog(gpf,setGpf,v)} colorFn={p=>({bg:paColor(p)+"22",text:paColor(p)})}/>
          <PillFilter label="Category" options={["Material","Process","Equipment","People","Measurement","Environment"]} selected={gcf} onToggle={v=>tog(gcf,setGcf,v)}/>
          {(gpf.length>0||gcf.length>0)&&<button onClick={()=>{setGpf([]);setGcf([]);}} style={{marginTop:8,background:"none",border:"none",color:"#4FA89A",fontSize:11,cursor:"pointer",fontFamily:FNTM}}>✕ Clear filters</button>}
          <div style={{marginTop:20,padding:"10px 0",borderTop:"1px solid #D8CEC3",fontSize:10,color:"#b0a898",fontFamily:FNTM,lineHeight:1.6}}>Nodes clustered by process area. Edges show rule↔assertion links. Filter by process to isolate knowledge chains.</div>
        </>}
      </div>

      {/* Main */}
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        {(view==="rules"||view==="assertions")&&<div style={{flex:1,padding:"20px 28px",overflow:"auto"}}>
          <div style={{fontSize:10,color:"#b0a898",fontFamily:FNTM,marginBottom:12,letterSpacing:0.8}}>{filtered.length} {view.toUpperCase()} · SORTED BY DATE</div>
          {filtered.length===0&&<div style={{padding:40,textAlign:"center",color:"#D8CEC3"}}>No {view} match your filters.</div>}
          {filtered.map(item=><div key={item.id} onClick={()=>setSel(item)} style={{padding:"16px 20px",marginBottom:8,background:sel?.id===item.id?"#f0eeec":"#FFFFFF",border:sel?.id===item.id?"1px solid #4FA89A40":"1px solid #e8e4e0",borderRadius:3,cursor:"pointer",transition:"all 0.12s"}} onMouseEnter={e=>{if(sel?.id!==item.id)e.currentTarget.style.background="#f8f6f4"}} onMouseLeave={e=>{if(sel?.id!==item.id)e.currentTarget.style.background="#FFFFFF"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <span style={{fontSize:11,color:"#b0a898",fontFamily:FNTM,fontWeight:600}}>{item.id}</span>
                {item.status&&<Badge label={item.status} colorFn={statusColor}/>}
                <Badge label={item.confidence} colorFn={confidenceColor}/>
                {contradictions.some(c=>c.ruleA.id===item.id||c.ruleB.id===item.id)&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:2,background:"#fde8e5",color:"#c0392b",fontWeight:700,fontFamily:FNTM}}>⚠ CONFLICT</span>}
                {checkStaleness(item).stale&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:2,background:"#fef3e2",color:"#F2652F",fontWeight:700,fontFamily:FNTM}}>STALE</span>}
              </div>
              <span style={{fontSize:10,color:"#D8CEC3",fontFamily:FNTM}}>{formatDate(item.createdAt)}</span>
            </div>
            <div style={{fontSize:14,color:"#1F1F1F",fontWeight:500,lineHeight:1.4,marginBottom:8}}>{item.title}</div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",gap:6,flexWrap:"wrap"}}><Tag label={item.category}/>{item.processArea&&<Tag label={item.processArea}/>}{(item.tags||[]).slice(0,3).map(t=><Tag key={t} label={t}/>)}</div>
              <span style={{fontSize:10,color:"#D8CEC3",fontFamily:FNTM}}>v{(item.versions||[]).length}</span>
            </div>
          </div>)}
        </div>}

        {/* Events list */}
        {view==="events"&&<div style={{flex:1,padding:"20px 28px",overflow:"auto"}}>
          <div style={{fontSize:10,color:"#b0a898",fontFamily:FNTM,marginBottom:12,letterSpacing:0.8}}>
            {events.filter(i=>{
              return (fCat.length===0||fCat.includes(i.outcome))&&(fStatus.length===0||fStatus.includes(i.impact))&&(fConf.length===0||fConf.includes(i.status))&&(fProc.length===0||fProc.includes(i.processArea));
            }).length} EVENTS · SORTED BY DATE
          </div>
          {events.filter(i=>(fCat.length===0||fCat.includes(i.outcome))&&(fStatus.length===0||fStatus.includes(i.impact))&&(fConf.length===0||fConf.includes(i.status))&&(fProc.length===0||fProc.includes(i.processArea))).map(ev=><div key={ev.id} onClick={()=>setShowEventDetail(ev)} style={{
            padding:"16px 20px",marginBottom:8,
            background:showEventDetail?.id===ev.id?"#f0eeec":"#FFFFFF",
            border:showEventDetail?.id===ev.id?`1px solid ${ev.outcome==="Positive"?"#4FA89A40":"#c0392b40"}`:"1px solid #e8e4e0",
            borderLeft:`3px solid ${ev.outcome==="Positive"?"#4FA89A50":"#c0392b50"}`,
            borderRadius:3,cursor:"pointer",transition:"all 0.12s",
          }} onMouseEnter={e=>{if(showEventDetail?.id!==ev.id)e.currentTarget.style.background="#f8f6f4"}} onMouseLeave={e=>{if(showEventDetail?.id!==ev.id)e.currentTarget.style.background="#FFFFFF"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <span style={{fontSize:11,color:"#b0a898",fontFamily:FNTM,fontWeight:600}}>{ev.id}</span>
                <Badge label={ev.outcome} colorFn={outcomeColor}/>
                <Badge label={ev.impact} colorFn={impactColor}/>
                <Badge label={ev.status} colorFn={eventStatusColor}/>
              </div>
              <span style={{fontSize:10,color:"#D8CEC3",fontFamily:FNTM}}>{formatDate(ev.date)}</span>
            </div>
            <div style={{fontSize:14,color:"#1F1F1F",fontWeight:500,lineHeight:1.4,marginBottom:8}}>{ev.title}</div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                <Tag label={ev.processArea}/>
                {(ev.tags||[]).slice(0,3).map(t=><Tag key={t} label={t}/>)}
              </div>
              <div style={{display:"flex",gap:4}}>
                {(ev.linkedRules||[]).length>0&&<span style={{fontSize:10,color:"#b0a898",fontFamily:FNTM}}>{ev.linkedRules.length}R</span>}
                {(ev.generatedRules||[]).length>0&&<span style={{fontSize:10,color:"#4FA89A",fontFamily:FNTM}}>+{ev.generatedRules.length} generated</span>}
              </div>
            </div>
          </div>)}
        </div>}

        {view==="graph"&&<div style={{flex:1,position:"relative"}}>
          {focusGraph&&<div style={{position:"absolute",top:12,left:12,zIndex:5,padding:"6px 12px",background:"#F2652F",color:"#fff",borderRadius:3,fontSize:11,fontFamily:FNTM,fontWeight:700,display:"flex",alignItems:"center",gap:8}}>
            Focused on {focusGraph} <button onClick={()=>setFocusGraph(null)} style={{background:"none",border:"none",color:"#fff",cursor:"pointer",fontSize:13,padding:0}}>✕</button>
          </div>}
          <GraphView rules={rules} assertions={assertions} gpf={gpf} gcf={gcf} onSelect={i=>setSel(i)} focusNodeId={focusGraph}/>
        </div>}

        {/* Knowledge Health View */}
        {view==="health"&&<div style={{flex:1,padding:"20px 28px",overflow:"auto"}}>
          {/* Health score summary */}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginBottom:24}}>
            <div style={{padding:"16px",background:contradictions.length>0?"#fde8e5":"#e6f5f1",borderRadius:3,border:"1px solid "+(contradictions.length>0?"#c0392b20":"#4FA89A20")}}>
              <div style={{fontSize:28,fontWeight:900,color:contradictions.length>0?"#c0392b":"#4FA89A",fontFamily:FNT}}>{contradictions.length}</div>
              <div style={{fontSize:11,color:"#5a5550",fontFamily:FNTM,fontWeight:600}}>Contradictions</div>
              <div style={{fontSize:10,color:"#8a8278",marginTop:2}}>Rules with opposing directives</div>
            </div>
            <div style={{padding:"16px",background:staleItems.length>0?"#fef3e2":"#e6f5f1",borderRadius:3,border:"1px solid "+(staleItems.length>0?"#F2652F20":"#4FA89A20")}}>
              <div style={{fontSize:28,fontWeight:900,color:staleItems.length>0?"#F2652F":"#4FA89A",fontFamily:FNT}}>{staleItems.length}</div>
              <div style={{fontSize:11,color:"#5a5550",fontFamily:FNTM,fontWeight:600}}>Stale Items</div>
              <div style={{fontSize:10,color:"#8a8278",marginTop:2}}>No activity in {STALE_DAYS}+ days</div>
            </div>
            <div style={{padding:"16px",background:confidenceDrifts.length>0?"#fef3e2":"#e6f5f1",borderRadius:3,border:"1px solid "+(confidenceDrifts.length>0?"#F2652F20":"#4FA89A20")}}>
              <div style={{fontSize:28,fontWeight:900,color:confidenceDrifts.length>0?"#F2652F":"#4FA89A",fontFamily:FNT}}>{confidenceDrifts.length}</div>
              <div style={{fontSize:11,color:"#5a5550",fontFamily:FNTM,fontWeight:600}}>Confidence Drifts</div>
              <div style={{fontSize:10,color:"#8a8278",marginTop:2}}>Label ≠ computed score</div>
            </div>
          </div>

          {/* Contradictions */}
          {contradictions.length>0&&<div style={{marginBottom:28}}>
            <div style={{fontSize:11,color:"#c0392b",textTransform:"uppercase",letterSpacing:1,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>⚠ CONTRADICTIONS DETECTED</div>
            <div style={{fontSize:12,color:"#5a5550",marginBottom:12,lineHeight:1.5}}>These rules share process area or category but contain opposing directives. Review and resolve — one may need to supersede the other, or their scopes may need refinement.</div>
            {contradictions.map((c,i)=><div key={i} style={{padding:"14px 16px",background:"#fff",border:"1px solid #c0392b20",borderRadius:3,marginBottom:8}}>
              <div style={{fontSize:10,color:"#c0392b",fontFamily:FNTM,fontWeight:700,marginBottom:6}}>CONFLICT IN {c.shared?.toUpperCase()}</div>
              <div style={{display:"flex",gap:12,marginBottom:8}}>
                <div style={{flex:1,padding:"8px 10px",background:"#f8f6f4",borderRadius:3,borderLeft:"3px solid #F2652F"}}>
                  <div style={{fontSize:10,color:"#8a8278",fontFamily:FNTM,fontWeight:600,marginBottom:2}}>{c.ruleA.id} · <Badge label={c.ruleA.confidence} colorFn={confidenceColor}/></div>
                  <div style={{fontSize:12,color:"#1F1F1F",lineHeight:1.3}}>{c.ruleA.title}</div>
                  {c.ruleA.scope&&<div style={{fontSize:10,color:"#b0a898",marginTop:3}}>Scope: {c.ruleA.scope}</div>}
                </div>
                <div style={{display:"flex",alignItems:"center",fontSize:16,color:"#c0392b",fontWeight:900}}>⇄</div>
                <div style={{flex:1,padding:"8px 10px",background:"#f8f6f4",borderRadius:3,borderLeft:"3px solid #F2652F"}}>
                  <div style={{fontSize:10,color:"#8a8278",fontFamily:FNTM,fontWeight:600,marginBottom:2}}>{c.ruleB.id} · <Badge label={c.ruleB.confidence} colorFn={confidenceColor}/></div>
                  <div style={{fontSize:12,color:"#1F1F1F",lineHeight:1.3}}>{c.ruleB.title}</div>
                  {c.ruleB.scope&&<div style={{fontSize:10,color:"#b0a898",marginTop:3}}>Scope: {c.ruleB.scope}</div>}
                </div>
              </div>
              <div style={{display:"flex",gap:6}}>
                <button onClick={()=>{openEdit(c.ruleA);setView("rules");}} style={{padding:"4px 10px",fontSize:10,background:"#fff",border:"1px solid #D8CEC3",borderRadius:3,cursor:"pointer",fontFamily:FNTM,fontWeight:600,color:"#5a5550"}}>Edit {c.ruleA.id}</button>
                <button onClick={()=>{openEdit(c.ruleB);setView("rules");}} style={{padding:"4px 10px",fontSize:10,background:"#fff",border:"1px solid #D8CEC3",borderRadius:3,cursor:"pointer",fontFamily:FNTM,fontWeight:600,color:"#5a5550"}}>Edit {c.ruleB.id}</button>
              </div>
            </div>)}
          </div>}

          {/* Confidence Drifts */}
          {confidenceDrifts.length>0&&<div style={{marginBottom:28}}>
            <div style={{fontSize:11,color:"#F2652F",textTransform:"uppercase",letterSpacing:1,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>CONFIDENCE RECALIBRATION NEEDED</div>
            <div style={{fontSize:12,color:"#5a5550",marginBottom:12,lineHeight:1.5}}>Evidence score suggests a different confidence level than the current label. Items with strong event corroboration or multiple evidence sources may deserve promotion.</div>
            {confidenceDrifts.map(item=>{
              const score = healthScores[item.id]||0;
              const computed = scoreToLabel(score);
              const isUpgrade = CONFIDENCES.indexOf(computed)>CONFIDENCES.indexOf(item.confidence);
              return <div key={item.id} style={{padding:"12px 16px",background:"#fff",border:"1px solid #D8CEC3",borderRadius:3,marginBottom:6,display:"flex",alignItems:"center",gap:12}}>
                <div style={{flex:1,cursor:"pointer"}} onClick={()=>{setView(item.type==="rule"?"rules":"assertions");setSel(item);}}>
                  <div style={{display:"flex",gap:6,alignItems:"center",marginBottom:4}}>
                    <span style={{fontSize:11,color:"#4FA89A",fontFamily:FNTM,fontWeight:600,textDecoration:"underline"}}>{item.id}</span>
                    {item.status&&<Badge label={item.status} colorFn={statusColor}/>}
                  </div>
                  <div style={{fontSize:13,color:"#1F1F1F",lineHeight:1.3}}>{item.title}</div>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:6,flexShrink:0}}>
                  <Badge label={item.confidence} colorFn={confidenceColor}/>
                  <span style={{fontSize:14,color:isUpgrade?"#4FA89A":"#c0392b"}}>{isUpgrade?"→":"→"}</span>
                  <Badge label={computed} colorFn={confidenceColor}/>
                  <span style={{fontSize:10,color:"#8a8278",fontFamily:FNTM}}>({score.toFixed(1)})</span>
                </div>
                <button onClick={()=>{
                  const u = p => p.map(r => r.id !== item.id ? r : {
                    ...r, confidence: computed,
                    versions: [...(r.versions||[]), { version: (r.versions||[]).length+1, date: new Date().toISOString(), author: "Health Engine", change: "Confidence recalibrated: "+item.confidence+" → "+computed+" (score: "+score.toFixed(1)+")", diffs: [{field:"confidence",from:item.confidence,to:computed}], fieldsChanged:["confidence"], snapshot: r.title }]
                  });
                  if(item.type==="rule") setRules(u); else setAssertions(u);
                }} style={{padding:"4px 10px",fontSize:10,background:isUpgrade?"#e6f5f1":"#fef3e2",border:"1px solid "+(isUpgrade?"#4FA89A30":"#F2652F30"),borderRadius:3,cursor:"pointer",fontFamily:FNTM,fontWeight:700,color:isUpgrade?"#4FA89A":"#F2652F",flexShrink:0}}>
                  Accept
                </button>
              </div>;
            })}
          </div>}

          {/* Stale Items */}
          {staleItems.length>0&&<div style={{marginBottom:28}}>
            <div style={{fontSize:11,color:"#8a8278",textTransform:"uppercase",letterSpacing:1,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>STALE KNOWLEDGE — REVIEW NEEDED</div>
            <div style={{fontSize:12,color:"#5a5550",marginBottom:12,lineHeight:1.5}}>These items haven't been updated or referenced by any event in over {STALE_DAYS} days. They may still be valid, but should be reviewed to confirm they remain current.</div>
            {staleItems.map(item=>{
              const st = checkStaleness(item);
              return <div key={item.id} style={{padding:"12px 16px",background:"#fff",border:"1px solid #D8CEC3",borderRadius:3,marginBottom:6,display:"flex",alignItems:"center",gap:12}}>
                <div style={{flex:1,cursor:"pointer"}} onClick={()=>{setView(item.type==="rule"?"rules":"assertions");setSel(item);}}>
                  <div style={{display:"flex",gap:6,alignItems:"center",marginBottom:4}}>
                    <span style={{fontSize:11,color:"#4FA89A",fontFamily:FNTM,fontWeight:600,textDecoration:"underline"}}>{item.id}</span>
                    {item.status&&<Badge label={item.status} colorFn={statusColor}/>}
                    <Badge label={item.confidence} colorFn={confidenceColor}/>
                    <span style={{fontSize:10,color:"#F2652F",fontFamily:FNTM,fontWeight:600}}>{st.daysSince}d stale</span>
                  </div>
                  <div style={{fontSize:13,color:"#1F1F1F",lineHeight:1.3}}>{item.title}</div>
                </div>
                <div style={{display:"flex",gap:4,flexShrink:0}}>
                  <button onClick={()=>{
                    const u = p => p.map(r => r.id !== item.id ? r : {
                      ...r, versions: [...(r.versions||[]), { version: (r.versions||[]).length+1, date: new Date().toISOString(), author: "Health Review", change: "Confirmed still valid after staleness review", diffs: [], fieldsChanged:[], snapshot: r.title }]
                    });
                    if(item.type==="rule") setRules(u); else setAssertions(u);
                  }} style={{padding:"4px 10px",fontSize:10,background:"#e6f5f1",border:"1px solid #4FA89A30",borderRadius:3,cursor:"pointer",fontFamily:FNTM,fontWeight:700,color:"#4FA89A"}}>
                    Confirm Valid
                  </button>
                  <button onClick={()=>{
                    const u = p => p.map(r => r.id !== item.id ? r : {
                      ...r, status: "Retired",
                      versions: [...(r.versions||[]), { version: (r.versions||[]).length+1, date: new Date().toISOString(), author: "Health Review", change: "Retired after staleness review — no longer applicable", diffs: [{field:"status",from:r.status,to:"Retired"}], fieldsChanged:["status"], snapshot: r.title }]
                    });
                    if(item.type==="rule") setRules(u); else setAssertions(u);
                  }} style={{padding:"4px 10px",fontSize:10,background:"#fde8e5",border:"1px solid #c0392b20",borderRadius:3,cursor:"pointer",fontFamily:FNTM,fontWeight:700,color:"#c0392b"}}>
                    Retire
                  </button>
                </div>
              </div>;
            })}
          </div>}

          {/* All clear */}
          {contradictions.length===0&&staleItems.length===0&&confidenceDrifts.length===0&&<div style={{padding:"40px 0",textAlign:"center"}}>
            <div style={{fontSize:32,marginBottom:8}}>✓</div>
            <div style={{fontSize:16,color:"#4FA89A",fontWeight:800,fontFamily:FNT}}>Knowledge Bank is Healthy</div>
            <div style={{fontSize:12,color:"#8a8278",marginTop:6,lineHeight:1.5}}>No contradictions, no stale items, all confidence levels aligned with evidence scores.</div>
          </div>}

          {/* Confidence score table */}
          <div style={{marginTop:8}}>
            <div style={{fontSize:11,color:"#062044",textTransform:"uppercase",letterSpacing:1,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>EVIDENCE SCORES — ALL ACTIVE ITEMS</div>
            <div style={{fontSize:10,color:"#8a8278",marginBottom:12,lineHeight:1.5,fontFamily:FNTM}}>
              Weights: Human Note ×3 · Event Analysis ×2 · LLM Extraction ×1 · Lab Data ×4 · Validated ×5 · Links ×0.5 · Event refs ×1.5 · Versions ×0.5 (max 2)
            </div>
            {[...rules,...assertions].filter(i=>i.status!=="Retired"&&i.status!=="Superseded").sort((a,b)=>(healthScores[b.id]||0)-(healthScores[a.id]||0)).map(item=>{
              const score = healthScores[item.id]||0;
              const computed = scoreToLabel(score);
              const match = computed === item.confidence;
              return <div key={item.id} onClick={()=>{setView(item.type==="rule"?"rules":"assertions");setSel(item);}} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 10px",borderRadius:3,marginBottom:3,background:match?"transparent":"#fef3e2",border:match?"1px solid transparent":"1px solid #F2652F15",cursor:"pointer"}} onMouseEnter={e=>e.currentTarget.style.background=match?"#f8f6f4":"#fef3e2"} onMouseLeave={e=>e.currentTarget.style.background=match?"transparent":"#fef3e2"}>
                <span style={{fontSize:10,color:"#4FA89A",fontFamily:FNTM,fontWeight:600,width:40,textDecoration:"underline"}}>{item.id}</span>
                <div style={{flex:1,fontSize:12,color:"#1F1F1F",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}}>{item.title}</div>
                <div style={{width:90,height:6,background:"#e8e4e0",borderRadius:3,overflow:"hidden",flexShrink:0}}>
                  <div style={{height:"100%",width:Math.min(score/15*100,100)+"%",background:score>=12?"#062044":score>=7?"#4FA89A":score>=3?"#F2652F":"#c0392b",borderRadius:3,transition:"width 0.3s"}}></div>
                </div>
                <span style={{fontSize:10,color:"#8a8278",fontFamily:FNTM,width:30,textAlign:"right"}}>{score.toFixed(1)}</span>
                <Badge label={item.confidence} colorFn={confidenceColor}/>
                {!match&&<span style={{fontSize:9,color:"#F2652F",fontFamily:FNTM}}>→{computed}</span>}
              </div>;
            })}
          </div>
        </div>}
      </div>

      {/* Detail panel */}
      {sel&&<div style={{width:360,borderLeft:"1px solid #e8e4e0",padding:"20px",overflow:"auto",flexShrink:0,background:"#f8f6f4"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <span style={{fontSize:12,color:"#b0a898",fontFamily:FNTM,fontWeight:700}}>{sel.id}</span>
          <div style={{display:"flex",gap:6}}>
            <button onClick={()=>openEdit(sel)} style={{padding:"4px 10px",borderRadius:4,fontSize:11,background:"#f0eeec",border:"1px solid #D8CEC3",color:"#8a8278",cursor:"pointer",fontFamily:FNTM}}>Edit</button>
            <button onClick={()=>setShowVer(sel)} style={{padding:"4px 10px",borderRadius:4,fontSize:11,background:"transparent",border:"1px solid #D8CEC3",color:"#b0a898",cursor:"pointer",fontFamily:FNTM}}>History</button>
            <button onClick={()=>{setFocusGraph(sel.id);setView("graph");}} style={{padding:"4px 10px",borderRadius:4,fontSize:11,background:"transparent",border:"1px solid #4FA89A",color:"#4FA89A",cursor:"pointer",fontFamily:FNTM,fontWeight:600}}>View in Graph</button>
            <button onClick={()=>setSel(null)} style={{background:"none",border:"none",color:"#b0a898",fontSize:16,cursor:"pointer"}}>✕</button>
          </div>
        </div>
        <h3 style={{fontSize:16,color:"#062044",fontWeight:700,lineHeight:1.4,marginBottom:16,fontFamily:FNT}}>{sel.title}</h3>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:20}}>
          {sel.status&&<Badge label={sel.status} colorFn={statusColor}/>}
          <Badge label={sel.confidence} colorFn={confidenceColor}/>
          <Tag label={sel.category}/>{sel.processArea&&<Tag label={sel.processArea}/>}
        </div>
        <div style={{marginBottom:18}}><div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontFamily:FNTM}}>Scope</div><div style={{fontSize:12,color:"#5a5550",lineHeight:1.5}}>{sel.scope||"—"}</div></div>
        {sel.rationale&&<div style={{marginBottom:18}}><div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontFamily:FNTM}}>Rationale</div><div style={{fontSize:12,color:"#5a5550",lineHeight:1.5}}>{sel.rationale}</div></div>}
        <div style={{marginBottom:18}}>
          <div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM}}>Evidence</div>
          {(sel.evidence||[]).map((ev,i)=><div key={i} style={{padding:"8px 10px",background:"#f8f6f4",borderRadius:4,marginBottom:4,border:"1px solid #D8CEC3"}}><div style={{fontSize:10,color:"#b0a898",fontFamily:FNTM,marginBottom:3}}>{ev.type.replace("_"," ").toUpperCase()} · {ev.date}</div><div style={{fontSize:12,color:"#8a8278",lineHeight:1.4}}>{ev.text}</div></div>)}
        </div>
        <div style={{marginBottom:18}}>
          <div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM}}>Linked {sel.type==="rule"?"Assertions":"Rules"}</div>
          <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
            {(sel.linkedAssertions||sel.linkedRules||[]).map(lid=><span key={lid} onClick={e=>{e.stopPropagation();const t=[...rules,...assertions].find(x=>x.id===lid);if(t)setSel(t);}} style={{padding:"2px 8px",borderRadius:3,fontSize:11,background:"#f0eeec",color:"#4FA89A",cursor:"pointer",fontFamily:FNTM,fontWeight:600,border:"1px solid #4FA89A30"}}>{lid}</span>)}
            {(sel.linkedAssertions||sel.linkedRules||[]).length===0&&<span style={{fontSize:11,color:"#D8CEC3"}}>None linked</span>}
          </div>
          {sel.autoLinkedReasons&&sel.autoLinkedReasons.length>0&&<div style={{marginTop:6,fontSize:10,color:"#4FA89A",fontFamily:FNTM,fontStyle:"italic"}}>Auto-linked by scope/tag similarity</div>}
        </div>
        {/* Suggest new links */}
        {(()=>{
          const existing = new Set(sel.linkedAssertions||sel.linkedRules||[]);
          const suggestions = computeLinks(sel, rules, assertions).filter(s=>!existing.has(s.id));
          if(suggestions.length===0) return null;
          return <div style={{marginBottom:18}}>
            <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM}}>Suggested Links</div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
              {suggestions.slice(0,4).map(s=><span key={s.id} style={{padding:"2px 8px",borderRadius:3,fontSize:10,background:"#e6f5f1",color:"#4FA89A",fontFamily:FNTM,border:"1px solid #4FA89A25",cursor:"default"}} title={s.title}>{s.id} <span style={{color:"#b0a898"}}>({s.score.toFixed(1)})</span></span>)}
            </div>
          </div>;
        })()}
        {(sel.tags||[]).length>0&&<div style={{marginBottom:18}}><div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM}}>Tags</div><div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{sel.tags.map(t=><Tag key={t} label={t}/>)}</div></div>}
        <div style={{padding:"10px 0",borderTop:"1px solid #D8CEC3",marginTop:12,fontSize:10,color:"#D8CEC3",fontFamily:FNTM}}><div>Created by: {sel.createdBy}</div><div>Created: {formatDate(sel.createdAt)}</div><div>Versions: {(sel.versions||[]).length}</div></div>
        {/* Health indicators */}
        {(()=>{
          const score = healthScores[sel.id]||0;
          const computed = scoreToLabel(score);
          const match = computed === sel.confidence;
          const st = checkStaleness(sel);
          const contras = contradictions.filter(c=>c.ruleA.id===sel.id||c.ruleB.id===sel.id);
          if(match&&!st.stale&&contras.length===0) return null;
          return <div style={{marginTop:8,padding:"10px 12px",background:contras.length>0?"#fde8e5":"#fef3e2",borderRadius:3,border:"1px solid "+(contras.length>0?"#c0392b20":"#F2652F20")}}>
            <div style={{fontSize:10,color:contras.length>0?"#c0392b":"#F2652F",fontFamily:FNTM,fontWeight:700,textTransform:"uppercase",letterSpacing:0.8,marginBottom:4}}>Health Alerts</div>
            {contras.length>0&&<div style={{fontSize:11,color:"#5a5550",lineHeight:1.4,marginBottom:4}}>⚠ Contradicts: {contras.map(c=>c.ruleA.id===sel.id?c.ruleB.id:c.ruleA.id).join(", ")}</div>}
            {!match&&<div style={{fontSize:11,color:"#5a5550",lineHeight:1.4,marginBottom:4}}>Evidence score ({score.toFixed(1)}) suggests {computed} confidence, currently {sel.confidence}</div>}
            {st.stale&&<div style={{fontSize:11,color:"#5a5550",lineHeight:1.4}}>No activity for {st.daysSince} days — review recommended</div>}
          </div>;
        })()}
      </div>}
    </div>

    {/* Add Modal */}
    <Modal open={showAdd} onClose={()=>setShowAdd(false)} title={`Add New ${view==="assertions"?"Assertion":"Rule"}`}>
      <Field label="Title / Statement"><input style={iS} value={form.title} onChange={e=>setForm({...form,title:e.target.value})} placeholder="e.g. Dilute Sims scrap with prime scrap when available"/></Field>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <Field label="Category"><TypeaheadInput value={form.category} onChange={v=>setForm({...form,category:v})} options={CATEGORIES} placeholder="Type category..."/></Field>
        <Field label="Process Area"><TypeaheadInput value={form.processArea} onChange={v=>setForm({...form,processArea:v})} options={PROCESS_AREAS} placeholder="Type process area..."/></Field>
      </div>
      <Field label="Scope" hint="e.g. Supplier = X; Process = EAF"><input style={iS} value={form.scope} onChange={e=>setForm({...form,scope:e.target.value})}/></Field>
      {view!=="assertions"&&<Field label="Rationale"><textarea style={{...iS,height:60,resize:"vertical"}} value={form.rationale} onChange={e=>setForm({...form,rationale:e.target.value})}/></Field>}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <Field label="Confidence"><select style={{...iS,cursor:"pointer"}} value={form.confidence} onChange={e=>setForm({...form,confidence:e.target.value})}>{CONFIDENCES.map(c=><option key={c} value={c}>{c}</option>)}</select></Field>
        {view!=="assertions"&&<Field label="Status"><select style={{...iS,cursor:"pointer"}} value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>{STATUSES.map(s=><option key={s} value={s}>{s}</option>)}</select></Field>}
      </div>
      <Field label="Tags" hint="Comma separated"><input style={iS} value={form.tags} onChange={e=>setForm({...form,tags:e.target.value})} placeholder="scrap, eaf, quality"/></Field>
      <Field label="Evidence / Source Note"><textarea style={{...iS,height:50,resize:"vertical"}} value={form.evidenceText} onChange={e=>setForm({...form,evidenceText:e.target.value})} placeholder="Where does this knowledge come from?"/></Field>
      <Field label="Author"><input style={iS} value={form.createdBy} onChange={e=>setForm({...form,createdBy:e.target.value})} placeholder="Name"/></Field>
      <button onClick={handleAdd} disabled={!form.title} style={{width:"100%",padding:"10px 0",borderRadius:3,fontSize:13,background:form.title?"#F2652F":"#f0eeec",border:"none",color:form.title?"#FFFFFF":"#444",cursor:form.title?"pointer":"not-allowed",fontFamily:FNTM,fontWeight:800,marginTop:8,letterSpacing:0.4}}>Save {view==="assertions"?"Assertion":"Rule"}</button>
    </Modal>

    {/* Edit Modal */}
    <Modal open={showEdit} onClose={()=>setShowEdit(false)} title={`Edit ${eForm?.id||""}`}>
      {eForm&&<>
        <Field label="Title / Statement"><input style={iS} value={eForm.title} onChange={e=>setEForm({...eForm,title:e.target.value})}/></Field>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <Field label="Category"><TypeaheadInput value={eForm.category} onChange={v=>setEForm({...eForm,category:v})} options={CATEGORIES} placeholder="Type category..."/></Field>
          <Field label="Process Area"><TypeaheadInput value={eForm.processArea||""} onChange={v=>setEForm({...eForm,processArea:v})} options={PROCESS_AREAS} placeholder="Type process area..."/></Field>
        </div>
        <Field label="Scope"><input style={iS} value={eForm.scope} onChange={e=>setEForm({...eForm,scope:e.target.value})}/></Field>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <Field label="Confidence"><select style={{...iS,cursor:"pointer"}} value={eForm.confidence} onChange={e=>setEForm({...eForm,confidence:e.target.value})}>{CONFIDENCES.map(c=><option key={c} value={c}>{c}</option>)}</select></Field>
          {eForm.type==="rule"&&<Field label="Status"><select style={{...iS,cursor:"pointer"}} value={eForm.status} onChange={e=>setEForm({...eForm,status:e.target.value})}>{STATUSES.map(s=><option key={s} value={s}>{s}</option>)}</select></Field>}
        </div>
        <Field label="Tags" hint="Comma separated"><input style={iS} value={eForm.tags} onChange={e=>setEForm({...eForm,tags:e.target.value})}/></Field>
        <div style={{borderTop:"1px solid #D8CEC3",paddingTop:14,marginTop:8}}>
          <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1.2,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>VERSION AUDIT TRAIL</div>
          <Field label="Change Note" hint="What changed and why?"><input style={iS} value={eForm.editNote} onChange={e=>setEForm({...eForm,editNote:e.target.value})} placeholder="e.g. Updated confidence after lab validation"/></Field>
          <Field label="Author"><input style={iS} value={eForm.editAuthor} onChange={e=>setEForm({...eForm,editAuthor:e.target.value})} placeholder="Your name"/></Field>
        </div>
        <button onClick={handleEdit} style={{width:"100%",padding:"10px 0",borderRadius:3,fontSize:13,background:"#F2652F",border:"none",color:"#FFFFFF",cursor:"pointer",fontFamily:FNTM,fontWeight:800,marginTop:4}}>Save Changes (v{(eForm.versions||[]).length+1})</button>
      </>}
    </Modal>

    {/* Version History */}
    <Modal open={!!showVer} onClose={()=>setShowVer(null)} title={`Version History · ${showVer?.id||""}`} width={680}>
      {showVer&&(showVer.versions||[]).slice().reverse().map(v=><div key={v.version} style={{padding:"14px 16px",background:"#f0eeec",border:"1px solid #D8CEC3",borderRadius:3,marginBottom:8}}>
        {/* Header row */}
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:13,color:"#4FA89A",fontWeight:800,fontFamily:FNTM}}>v{v.version}</span>
            {v.fieldsChanged&&v.fieldsChanged.length>0&&<span style={{fontSize:10,color:"#b0a898",fontFamily:FNTM}}>{v.fieldsChanged.length} field{v.fieldsChanged.length>1?"s":""} changed</span>}
          </div>
          <span style={{fontSize:10,color:"#b0a898",fontFamily:FNTM}}>{formatDate(v.date)}</span>
        </div>

        {/* Author + reasoning */}
        <div style={{display:"flex",gap:16,marginBottom:v.diffs&&v.diffs.length>0?10:0,padding:"6px 10px",background:"#f8f6f4",borderRadius:2,border:"1px solid #D8CEC3"}}>
          <div style={{flex:0,minWidth:80}}>
            <div style={{fontSize:9,color:"#b0a898",textTransform:"uppercase",letterSpacing:0.8,fontFamily:FNTM,marginBottom:2}}>Author</div>
            <div style={{fontSize:12,color:"#1F1F1F",fontFamily:FNT,fontWeight:600}}>{v.author}</div>
          </div>
          <div style={{flex:1,borderLeft:"1px solid #D8CEC3",paddingLeft:16}}>
            <div style={{fontSize:9,color:"#b0a898",textTransform:"uppercase",letterSpacing:0.8,fontFamily:FNTM,marginBottom:2}}>Reasoning</div>
            <div style={{fontSize:12,color:"#5a5550",fontFamily:FNT,lineHeight:1.4}}>{v.change}</div>
          </div>
          <div style={{flex:0,minWidth:100,borderLeft:"1px solid #D8CEC3",paddingLeft:16}}>
            <div style={{fontSize:9,color:"#b0a898",textTransform:"uppercase",letterSpacing:0.8,fontFamily:FNTM,marginBottom:2}}>Timestamp</div>
            <div style={{fontSize:11,color:"#8a8278",fontFamily:FNTM}}>{v.date?new Date(v.date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}):"—"}</div>
          </div>
        </div>

        {/* Field-level diffs */}
        {v.diffs&&v.diffs.length>0&&<div style={{marginTop:6}}>
          {v.diffs.map((d,di)=><div key={di} style={{display:"flex",alignItems:"flex-start",gap:8,padding:"5px 10px",marginBottom:2,background:"#FFFFFF",borderRadius:2,border:"1px solid #D8CEC3"}}>
            <span style={{fontSize:10,color:"#F2652F",fontFamily:FNTM,fontWeight:700,minWidth:80,textTransform:"uppercase",paddingTop:1}}>{d.field}</span>
            <div style={{flex:1,fontSize:11,fontFamily:FNT,lineHeight:1.4}}>
              {d.from&&<span style={{color:"#c0392b",textDecoration:"line-through",opacity:0.7}}>{d.from}</span>}
              {d.from&&d.to&&<span style={{color:"#b0a898",margin:"0 6px"}}>→</span>}
              {d.to&&<span style={{color:"#4FA89A"}}>{d.to}</span>}
            </div>
          </div>)}
        </div>}

        {/* Snapshot for v1 or entries without diffs */}
        {(!v.diffs||v.diffs.length===0)&&<div style={{fontSize:12,color:"#8a8278",lineHeight:1.4,padding:"6px 10px",background:"#FFFFFF",borderRadius:2,marginTop:6,border:"1px solid #D8CEC3"}}>{v.snapshot}</div>}
      </div>)}
    </Modal>

    {/* Narrative Input */}
    <Modal open={showNarr} onClose={()=>{setShowNarr(false);setParsed(null);setParseError(null);setRecording(false);if(recognitionRef.current)recognitionRef.current.stop();}} title="Narrative Knowledge Input" width={740}>
      <div style={{fontSize:12,color:"#8a8278",lineHeight:1.6,marginBottom:16}}>Capture knowledge from any source — type, speak, or upload documents. System will extract structured assertions and rules, categorize them, and auto-link to existing knowledge.</div>

      {/* Input method tabs */}
      <div style={{display:"flex",gap:8,marginBottom:16}}>
        <label style={{flex:1,padding:"12px",borderRadius:3,fontSize:12,fontWeight:700,fontFamily:FNTM,cursor:"pointer",textAlign:"center",border:"1px solid #D8CEC3",background:fileLoading?"#fef3e2":"#f8f6f4",color:"#5a5550",position:"relative",overflow:"hidden"}}>
          <input type="file" accept=".txt,.md,.csv,.pdf,.docx,.doc" onChange={handleFileUpload} style={{position:"absolute",top:0,left:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"}}/>
          {fileLoading ? "Reading file..." : "Upload Document"}
          <div style={{fontSize:9,color:"#b0a898",marginTop:2,fontWeight:400}}>PDF, Word, TXT, CSV</div>
        </label>
        <button onClick={toggleVoice} style={{flex:1,padding:"12px",borderRadius:3,fontSize:12,fontWeight:700,fontFamily:FNTM,cursor:"pointer",textAlign:"center",border:recording?"2px solid #c0392b":"1px solid #D8CEC3",background:recording?"#fde8e5":"#f8f6f4",color:recording?"#c0392b":"#5a5550"}}>
          {recording ? "Stop Recording" : "Voice Input"}
          <div style={{fontSize:9,color:recording?"#c0392b":"#b0a898",marginTop:2,fontWeight:400}}>{recording?"Listening — speak now...":"Speak and auto-transcribe"}</div>
        </button>
      </div>

      {recording&&<div style={{padding:"8px 12px",background:"#fde8e5",borderRadius:3,marginBottom:12,display:"flex",alignItems:"center",gap:8}}>
        <div style={{width:8,height:8,borderRadius:"50%",background:"#c0392b",animation:"pulse 1s infinite"}}/>
        <span style={{fontSize:11,color:"#c0392b",fontFamily:FNTM,fontWeight:600}}>Recording — speak clearly. Text appears below in real time.</span>
        <style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}`}</style>
      </div>}

      <Field label="Operator Narrative" hint="Free-text in any format — voice transcription, shift logs, operator notes, event reports">
        <textarea style={{...iS,height:120,resize:"vertical",lineHeight:1.5}} value={narr} onChange={e=>setNarr(e.target.value)} placeholder={"e.g. Sims Metal Management tends to deliver lower quality shredded scrap. We need to undergo longer heats in the EAF to ensure adequate liquid steel quality. If available, this should be diluted with prime scrap from other suppliers or DRI..."}/>
      </Field>

      {parseError && <div style={{padding:"10px 14px",background:"#fde8e5",border:"1px solid #e8c0b8",borderRadius:3,marginBottom:12,fontSize:12,color:"#c0392b",fontFamily:FNTM}}>{parseError}</div>}

      {!parsed&&!parsing&&<button onClick={parseNarr} disabled={narr.length<20} style={{width:"100%",padding:"10px 0",borderRadius:3,fontSize:13,background:narr.length>=20?"#f0eeec":"#111",border:`1px solid ${narr.length>=20?"#F2652F":"#f0eeec"}`,color:narr.length>=20?"#F2652F":"#333",cursor:narr.length>=20?"pointer":"not-allowed",fontFamily:FNTM,fontWeight:700,letterSpacing:0.4}}>Extract Industrial Knowledge →</button>}

      {parsing&&<div style={{width:"100%",padding:"16px 0",textAlign:"center"}}>
        <div style={{display:"inline-block",width:20,height:20,border:"2px solid #4FA89A",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/>        <div style={{fontSize:11,color:"#8a8278",marginTop:8,fontFamily:FNTM}}>Extracting industrial knowledge...</div>
        <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
      </div>}

      {parsed&&<div style={{marginTop:16}}>
        {/* Event context */}
        <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1.2,marginBottom:8,fontFamily:FNTM,fontWeight:700}}>EXTRACTED CONTEXT</div>
        <div style={{padding:"10px 14px",background:"#f0eeec",border:"1px solid #D8CEC3",borderRadius:3,marginBottom:16}}>
          <div style={{fontSize:12,color:"#1F1F1F",marginBottom:6}}><span style={{color:"#8a8278"}}>Event type:</span> {parsed.eventType}</div>
          <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
            <Tag label={`Category: ${parsed.category}`}/><Tag label={`Process: ${parsed.processArea}`}/>
            {parsed.scope&&<Tag label={`Scope: ${parsed.scope}`}/>}
            {parsed.tags.map(t=><Tag key={t} label={t}/>)}
          </div>
        </div>

        {/* Assertions — editable before accepting */}
        <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:8,fontFamily:FNTM,fontWeight:700}}>ASSERTIONS ({parsed.assertions.length}) — edit before accepting</div>
        {parsed.assertions.map((a,i)=><div key={i} style={{padding:"10px 12px",background:"#f8f6f4",borderRadius:3,marginBottom:6,border:"1px solid #D8CEC3"}}>
          <input value={a.title} onChange={e=>{const u={...parsed,assertions:parsed.assertions.map((x,j)=>j===i?{...x,title:e.target.value}:x)};setParsed(u);}} style={{...iS,fontSize:12,fontWeight:500,marginBottom:6,background:"#fff"}}/>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <TypeaheadInput value={a.category} onChange={v=>{const u={...parsed,assertions:parsed.assertions.map((x,j)=>j===i?{...x,category:v}:x)};setParsed(u);}} options={CATEGORIES} placeholder="Category"/>
            <select value={a.confidence} onChange={e=>{const u={...parsed,assertions:parsed.assertions.map((x,j)=>j===i?{...x,confidence:e.target.value}:x)};setParsed(u);}} style={{...iS,width:110,cursor:"pointer"}}>{CONFIDENCES.map(c=><option key={c} value={c}>{c}</option>)}</select>
            <input value={a.scope||""} onChange={e=>{const u={...parsed,assertions:parsed.assertions.map((x,j)=>j===i?{...x,scope:e.target.value}:x)};setParsed(u);}} style={{...iS,flex:1,fontSize:11}} placeholder="Scope"/>
            <button onClick={()=>{const u={...parsed,assertions:parsed.assertions.filter((_,j)=>j!==i)};setParsed(u);}} style={{background:"none",border:"none",color:"#c0392b",cursor:"pointer",fontSize:14,padding:"0 4px"}}>✕</button>
          </div>
        </div>)}

        {/* Rules — editable before accepting */}
        <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:8,marginTop:16,fontFamily:FNTM,fontWeight:700}}>RULES ({parsed.rules.length}) — edit before accepting</div>
        {parsed.rules.map((r,i)=><div key={i} style={{padding:"10px 12px",background:"#f8f6f4",borderRadius:3,marginBottom:6,border:"1px solid #D8CEC3"}}>
          <input value={r.title} onChange={e=>{const u={...parsed,rules:parsed.rules.map((x,j)=>j===i?{...x,title:e.target.value}:x)};setParsed(u);}} style={{...iS,fontSize:12,fontWeight:500,marginBottom:4,background:"#fff"}}/>
          <input value={r.rationale||""} onChange={e=>{const u={...parsed,rules:parsed.rules.map((x,j)=>j===i?{...x,rationale:e.target.value}:x)};setParsed(u);}} style={{...iS,fontSize:11,fontStyle:"italic",marginBottom:6,background:"#fff"}} placeholder="Rationale"/>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <TypeaheadInput value={r.category} onChange={v=>{const u={...parsed,rules:parsed.rules.map((x,j)=>j===i?{...x,category:v}:x)};setParsed(u);}} options={CATEGORIES} placeholder="Category"/>
            <TypeaheadInput value={r.processArea} onChange={v=>{const u={...parsed,rules:parsed.rules.map((x,j)=>j===i?{...x,processArea:v}:x)};setParsed(u);}} options={PROCESS_AREAS} placeholder="Process area"/>
            <select value={r.confidence} onChange={e=>{const u={...parsed,rules:parsed.rules.map((x,j)=>j===i?{...x,confidence:e.target.value}:x)};setParsed(u);}} style={{...iS,width:110,cursor:"pointer"}}>{CONFIDENCES.map(c=><option key={c} value={c}>{c}</option>)}</select>
            <button onClick={()=>{const u={...parsed,rules:parsed.rules.filter((_,j)=>j!==i)};setParsed(u);}} style={{background:"none",border:"none",color:"#c0392b",cursor:"pointer",fontSize:14,padding:"0 4px"}}>✕</button>
          </div>
        </div>)}

        {/* Auto-link preview */}
        {(()=>{
          const previewLinks = parsed.rules.map(r => {
            const tempItem = { ...r, type: "rule", tags: parsed.tags };
            return { rule: r.title, links: computeLinks(tempItem, rules, assertions) };
          }).filter(x => x.links.length > 0);
          if (previewLinks.length === 0) return null;
          return <div style={{marginTop:16}}>
            <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:8,fontFamily:FNTM,fontWeight:700}}>AUTO-LINK SUGGESTIONS</div>
            {previewLinks.map((pl,i)=><div key={i} style={{padding:"8px 12px",background:"#e6f5f1",borderRadius:3,marginBottom:4,border:"1px solid #4FA89A30"}}>
              <div style={{fontSize:10,color:"#8a8278",marginBottom:4,fontFamily:FNTM}}>{pl.rule.slice(0,60)}...</div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                {pl.links.map(l=><span key={l.id} style={{padding:"2px 8px",borderRadius:3,fontSize:10,background:"#f0eeec",color:"#4FA89A",fontFamily:FNTM,border:"1px solid #4FA89A30"}}>{l.id} <span style={{color:"#b0a898"}}>({l.score.toFixed(1)})</span></span>)}
              </div>
            </div>)}
          </div>;
        })()}

        <div style={{padding:"10px 14px",background:"#fef3e2",border:"1px solid #F2652F30",borderRadius:3,marginTop:16,fontSize:11,color:"#F2652F",fontFamily:FNTM,lineHeight:1.5}}>
          ⚠ AI-extracted — all items created with status "Proposed" and flagged for human review. Auto-links are based on scope/tag/category overlap scores.
        </div>

        <button onClick={acceptNarr} style={{width:"100%",padding:"10px 0",borderRadius:3,fontSize:13,marginTop:12,background:"#F2652F",border:"none",color:"#FFFFFF",cursor:"pointer",fontFamily:FNTM,fontWeight:700}}>Accept & Store {parsed.assertions.length} Assertions + {parsed.rules.length} Rules</button>
      </div>}
    </Modal>

    {/* Event Detail Modal */}
    <Modal open={!!showEventDetail} onClose={()=>{setShowEventDetail(null);setGenError(null);}} title={`Event ${showEventDetail?.id||""}`} width={760}>
      {showEventDetail&&<div>
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          <Badge label={showEventDetail.outcome} colorFn={outcomeColor}/>
          <Badge label={showEventDetail.impact} colorFn={impactColor}/>
          <Badge label={showEventDetail.status} colorFn={eventStatusColor}/>
          <Tag label={showEventDetail.processArea}/>
          <span style={{fontSize:10,color:"#b0a898",fontFamily:FNTM,marginLeft:"auto"}}>{formatDate(showEventDetail.date)} · {showEventDetail.reportedBy}</span>
        </div>
        <h3 style={{fontSize:16,color:"#062044",fontWeight:700,lineHeight:1.4,marginBottom:12,fontFamily:FNT}}>{showEventDetail.title}</h3>
        <div style={{fontSize:12,color:"#5a5550",lineHeight:1.6,marginBottom:16,padding:"10px 14px",background:"#f8f6f4",borderRadius:3,border:`1px solid ${showEventDetail.outcome==="Positive"?"#4FA89A15":"#D8CEC380"}`}}>{showEventDetail.description}</div>

        {/* Ishikawa display — adapts label to outcome */}
        <div style={{fontSize:10,color:"#F2652F",textTransform:"uppercase",letterSpacing:1.2,marginBottom:10,fontFamily:FNTM,fontWeight:700}}>{showEventDetail.outcome==="Positive"?"SUCCESS FACTOR ANALYSIS — ISHIKAWA":"ROOT CAUSE ANALYSIS — ISHIKAWA"}</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}}>
          {ISHIKAWA_CATS.map(cat=>{
            const items = (showEventDetail.ishikawa||{})[cat]||[];
            if(items.length===0) return null;
            const catColors = {Material:"#F2652F",Process:"#4FA89A",Equipment:"#888",People:"#c0392b",Measurement:"#5a5550",Environment:"#666"};
            return <div key={cat} style={{padding:"10px 12px",background:"#f8f6f4",borderRadius:3,border:`1px solid ${catColors[cat]||"#222"}25`}}>
              <div style={{fontSize:10,color:catColors[cat]||"#888",fontWeight:700,fontFamily:FNTM,textTransform:"uppercase",letterSpacing:0.8,marginBottom:6}}>{cat}</div>
              {items.map((item,i)=><div key={i} style={{fontSize:11,color:"#1F1F1F",lineHeight:1.4,marginBottom:3,paddingLeft:8,borderLeft:`2px solid ${catColors[cat]||"#333"}40`}}>{item}</div>)}
            </div>;
          })}
        </div>

        {/* Resolution / Outcome Notes */}
        {showEventDetail.resolution&&<div style={{marginBottom:16}}>
          <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM,fontWeight:700}}>{showEventDetail.outcome==="Positive"?"Outcome & Takeaways":"Resolution"}</div>
          <div style={{fontSize:12,color:"#5a5550",lineHeight:1.5}}>{showEventDetail.resolution}</div>
        </div>}

        {/* Linked knowledge */}
        <div style={{display:"flex",gap:16,marginBottom:16}}>
          {(showEventDetail.linkedRules||[]).length>0&&<div>
            <div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontFamily:FNTM}}>Linked Rules</div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{showEventDetail.linkedRules.map(lid=><span key={lid} style={{padding:"2px 8px",borderRadius:2,fontSize:11,background:"#f0eeec",color:"#4FA89A",fontFamily:FNTM,fontWeight:600,border:"1px solid #4FA89A30"}}>{lid}</span>)}</div>
          </div>}
          {(showEventDetail.linkedAssertions||[]).length>0&&<div>
            <div style={{fontSize:10,color:"#b0a898",textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontFamily:FNTM}}>Linked Assertions</div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{showEventDetail.linkedAssertions.map(lid=><span key={lid} style={{padding:"2px 8px",borderRadius:2,fontSize:11,background:"#f0eeec",color:"#8a8278",fontFamily:FNTM,fontWeight:600,border:"1px solid #D8CEC3"}}>{lid}</span>)}</div>
          </div>}
        </div>

        {/* Generated knowledge */}
        {((showEventDetail.generatedRules||[]).length>0||(showEventDetail.generatedAssertions||[]).length>0)&&<div style={{padding:"10px 14px",background:"#e6f5f1",border:"1px solid #4FA89A20",borderRadius:3,marginBottom:16}}>
          <div style={{fontSize:10,color:"#4FA89A",textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontFamily:FNTM,fontWeight:700}}>Knowledge Generated From This Incident</div>
          <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
            {(showEventDetail.generatedRules||[]).map(id=><span key={id} style={{padding:"2px 8px",borderRadius:2,fontSize:11,background:"#f0eeec",color:"#4FA89A",fontFamily:FNTM,fontWeight:600}}>{id}</span>)}
            {(showEventDetail.generatedAssertions||[]).map(id=><span key={id} style={{padding:"2px 8px",borderRadius:2,fontSize:11,background:"#f0eeec",color:"#8a8278",fontFamily:FNTM,fontWeight:600}}>{id}</span>)}
          </div>
        </div>}

        {/* Generate rules button */}
        {genError&&<div style={{padding:"10px 14px",background:"#fde8e5",border:"1px solid #c0392b30",borderRadius:3,marginBottom:8,fontSize:12,color:"#c0392b",fontFamily:FNTM,lineHeight:1.5}}>Error: {genError}</div>}
        {generating&&<div style={{padding:"10px 14px",background:"#fef3e2",border:"1px solid #F2652F30",borderRadius:3,marginBottom:8,fontSize:12,color:"#F2652F",fontFamily:FNTM,textAlign:"center"}}>
          <div style={{display:"inline-block",width:14,height:14,border:"2px solid #F2652F40",borderTopColor:"#F2652F",borderRadius:"50%",animation:"spin 0.8s linear infinite",marginRight:8,verticalAlign:"middle"}}></div>
          Analyzing event...
          <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
        </div>}
        <button type="button" onClick={()=>{setGenError(null);generateFromEvent(showEventDetail);}} disabled={generating} style={{width:"100%",padding:"12px 0",borderRadius:3,fontSize:13,background:generating?"#e8e4e0":"#F2652F",border:"none",color:generating?"#8a8278":"#FFFFFF",cursor:generating?"not-allowed":"pointer",fontFamily:FNTM,fontWeight:800,letterSpacing:0.4}}>
          {generating?"Generating...":`Generate ${showEventDetail.outcome==="Positive"?"Best-Practice":"Preventive"} Rules & Assertions`}
        </button>
      </div>}
    </Modal>

    {/* Report Event Modal */}
    <Modal open={showEvent} onClose={()=>setShowEvent(false)} title="Report Event" width={760}>
      <div style={{fontSize:12,color:"#8a8278",lineHeight:1.6,marginBottom:16}}>Document an operational event — positive or negative — with structured Ishikawa analysis. Each Ishikawa category captures contributing factors. After filing, you can generate rules and assertions that capture what worked or what to prevent.</div>

      <Field label="Event Title"><input style={iS} value={evForm.title} onChange={e=>setEvForm({...evForm,title:e.target.value})} placeholder="e.g. Zero-defect HSLA campaign — Heats #4810-4818"/></Field>

      {/* Outcome toggle */}
      <div style={{display:"flex",gap:8,marginBottom:16}}>
        {EVENT_OUTCOMES.map(o=><button key={o} onClick={()=>setEvForm({...evForm,outcome:o})} style={{flex:1,padding:"10px",borderRadius:3,fontSize:13,fontWeight:800,fontFamily:FNTM,letterSpacing:0.4,cursor:"pointer",border:evForm.outcome===o?`2px solid ${o==="Positive"?"#4FA89A":"#F2652F"}`:"2px solid #D8CEC3",background:evForm.outcome===o?(o==="Positive"?"#e6f5f1":"#fde8e5"):"#FFFFFF",color:evForm.outcome===o?(o==="Positive"?"#4FA89A":"#F2652F"):"#b0a898",transition:"all 0.15s"}}>
          {o==="Positive"?"✓ Positive Outcome":"✗ Negative Outcome"}
        </button>)}
      </div>

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}}>
        <Field label="Process Area"><TypeaheadInput value={evForm.processArea} onChange={v=>setEvForm({...evForm,processArea:v})} options={PROCESS_AREAS} placeholder="Type process area..."/></Field>
        <Field label="Impact"><select style={{...iS,cursor:"pointer"}} value={evForm.impact} onChange={e=>setEvForm({...evForm,impact:e.target.value})}>{IMPACTS.map(s=><option key={s} value={s}>{s}</option>)}</select></Field>
        <Field label="Reported By"><input style={iS} value={evForm.reportedBy} onChange={e=>setEvForm({...evForm,reportedBy:e.target.value})} placeholder="Name"/></Field>
      </div>
      <Field label="Description"><textarea style={{...iS,height:70,resize:"vertical",lineHeight:1.5}} value={evForm.description} onChange={e=>setEvForm({...evForm,description:e.target.value})} placeholder={evForm.outcome==="Positive"?"What went well? Include heat numbers, product grades, conditions that drove success...":"What happened? Include heat numbers, product grades, timing..."}/></Field>

      {/* Ishikawa input grid */}
      <div style={{fontSize:10,color:"#F2652F",textTransform:"uppercase",letterSpacing:1.2,marginBottom:10,fontFamily:FNTM,fontWeight:700,marginTop:8}}>{evForm.outcome==="Positive"?"SUCCESS FACTOR ANALYSIS — ISHIKAWA":"ROOT CAUSE ANALYSIS — ISHIKAWA"}</div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}}>
        {ISHIKAWA_CATS.map(cat=>{
          const catColors = {Material:"#F2652F",Process:"#4FA89A",Equipment:"#888",People:"#c0392b",Measurement:"#CCC",Environment:"#666"};
          return <div key={cat} style={{padding:"10px 12px",background:"#f8f6f4",borderRadius:3,border:`1px solid ${catColors[cat]||"#222"}20`}}>
            <div style={{fontSize:10,color:catColors[cat]||"#888",fontWeight:700,fontFamily:FNTM,textTransform:"uppercase",letterSpacing:0.8,marginBottom:6}}>{cat}</div>
            {evForm.ishikawa[cat].map((val,i)=><div key={i} style={{display:"flex",gap:4,marginBottom:4}}>
              <input style={{...iS,fontSize:11,padding:"4px 8px"}} value={val} onChange={e=>updateIshikawa(cat,i,e.target.value)} placeholder={`${cat} factor...`}/>
              {evForm.ishikawa[cat].length>1&&<button onClick={()=>removeIshikawaRow(cat,i)} style={{background:"none",border:"none",color:"#b0a898",cursor:"pointer",fontSize:14,padding:"0 4px"}}>✕</button>}
            </div>)}
            <button onClick={()=>addIshikawaRow(cat)} style={{background:"none",border:"none",color:catColors[cat]||"#555",cursor:"pointer",fontSize:10,fontFamily:FNTM,fontWeight:600,padding:"2px 0"}}>+ Add {cat.toLowerCase()} factor</button>
          </div>;
        })}
      </div>

      <Field label={evForm.outcome==="Positive"?"Outcome & Takeaways":"Resolution / Corrective Actions"} hint={evForm.outcome==="Positive"?"What made this successful? What should be replicated?":"Leave blank if still investigating"}>
        <textarea style={{...iS,height:50,resize:"vertical"}} value={evForm.resolution} onChange={e=>setEvForm({...evForm,resolution:e.target.value})} placeholder={evForm.outcome==="Positive"?"What conditions, decisions, or practices drove this success?":"What was done to resolve this?"}/>
      </Field>
      <Field label="Tags" hint="Comma separated"><input style={iS} value={evForm.tags} onChange={e=>setEvForm({...evForm,tags:e.target.value})} placeholder={evForm.outcome==="Positive"?"hsla, zero-defect, best-practice, casting":"cracking, hsla, sims, casting"}/></Field>

      <button onClick={handleAddEvent} disabled={!evForm.title} style={{width:"100%",padding:"10px 0",borderRadius:3,fontSize:13,background:evForm.title?(evForm.outcome==="Positive"?"#4FA89A":"#c0392b"):"#f0eeec",border:"none",color:evForm.title?"#FFFFFF":"#444",cursor:evForm.title?"pointer":"not-allowed",fontFamily:FNTM,fontWeight:800,marginTop:8,letterSpacing:0.4}}>File Event Report</button>
    </Modal>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(KnowledgeRuleBank));
</script>
</body>
</html>
